// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// SIMPLE AUTH MODULE
// ===============================================

// --- Enums ---

enum Role {
  ADMIN
  MANAGER
  USER
}

// --- Entidades ---

model User {
  id String @id @default(uuid())

  // Credentials
  username      String? @db.VarChar(32)
  email         String  @db.VarChar(254)
  password_hash String  @db.VarChar(100)

  // User Roles
  role Role @default(USER)

  // Access Control
  lastLoginIp         String?   @map("last_login_ip")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  blockedUntil        DateTime? @map("blocked_until")

  // Recovery
  passwordResetToken   String?   @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  profile                  UserProfile?
  RefreshToken             RefreshToken[]
  sessions                 Session[]
  ItemMovement             ItemMovement[]
  ApprovedMovements        ItemMovement[]           @relation("ApprovedMovements")
  AuditLogs                AuditLog[]
  VariantPriceHistory      VariantPriceHistory[]
  Alerts                   Alert[]
  CreatedPurchaseOrders    PurchaseOrder[]          @relation("CreatedPurchaseOrders")
  CreatedSalesOrders       SalesOrder[]             @relation("CreatedSalesOrders")
  ItemReservations         ItemReservation[]
  Comments                 Comment[]
  NotificationPreferences  NotificationPreference[]
  Notifications            Notification[]
  permissionGroups         UserPermissionGroup[]
  grantedPermissions       UserPermissionGroup[]    @relation("GrantedPermissions")
  directPermissions        UserDirectPermission[]   @relation("UserDirectPermissions")
  grantedDirectPermissions UserDirectPermission[]   @relation("GrantedDirectPermissions")
  permissionAuditLogs      PermissionAuditLog[]
  RequestsCreated          Request[]                @relation("RequestsCreated")
  RequestsAssigned         Request[]                @relation("RequestsAssigned")
  UploadedAttachments      RequestAttachment[]      @relation("UploadedAttachments")
  RequestComments          RequestComment[]         @relation("RequestComments")
  RequestHistoryActions    RequestHistory[]         @relation("RequestHistoryActions")

  // HR Relations
  employee Employee?

  // Payroll Relations
  processedPayrolls Payroll[] @relation("PayrollProcessor")
  approvedPayrolls  Payroll[] @relation("PayrollApprover")
  paidPayrolls      Payroll[] @relation("PayrollPayer")

  // Overtime Relations
  approvedOvertime Overtime[]

  // Absence Relations
  approvedAbsences Absence[]

  @@unique([email, deletedAt], name: "users_email_unique_active")
  @@unique([username, deletedAt], name: "users_username_unique_active")
  // Optimizations
  @@index([failedLoginAttempts, blockedUntil, lastLoginIp])
  @@index([passwordResetToken, passwordResetExpires])
  @@index([role])
  @@index([id, deletedAt])
  @@map("users")
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Personal Information
  name     String    @default("") @db.VarChar(64)
  surname  String    @default("") @db.VarChar(64)
  birthday DateTime? @db.Date
  location String    @default("") @db.VarChar(128)

  // Secondary Information
  bio       String @default("") @db.VarChar(256)
  avatarUrl String @default("") @map("avatar_url") @db.VarChar(512)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

model Session {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  ip         String    @db.VarChar(64)
  createdAt  DateTime  @default(now()) @map("created_at")
  expiredAt  DateTime? @map("expired_at")
  revokedAt  DateTime? @map("revoked_at")
  lastUsedAt DateTime? @map("last_used_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([ip])
  @@map("sessions")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  sessionId String    @map("session_id")
  token     String    @unique @db.VarChar(512)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([token])
  @@map("refresh_tokens")
}

// ===============================================
// RBAC MODULE
// ===============================================

/// Representa uma permissão específica no sistema
model Permission {
  id String @id @default(uuid())

  // Identificador único da permissão (ex: core.users.create)
  code String @unique @db.VarChar(128)

  // Nome legível da permissão
  name String @db.VarChar(128)

  // Descrição detalhada do que a permissão permite
  description String? @db.Text

  // Módulo ao qual a permissão pertence
  module String @db.VarChar(64) // core, stock, sales

  // Recurso ao qual a permissão se aplica
  resource String @db.VarChar(64) // users, products, orders

  // Ação permitida
  action String @db.VarChar(64) // create, read, update, delete, request, approve

  // Se é uma permissão do sistema (não pode ser deletada)
  isSystem Boolean @default(false) @map("is_system")

  // Metadados adicionais (para ABAC futuramente)
  metadata Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  permissionGroups PermissionGroupPermission[]
  directUsers      UserDirectPermission[]

  @@index([module, resource, action])
  @@index([code])
  @@index([module])
  @@map("permissions")
}

/// Grupo de permissões (equivalente a uma Role customizável)
model PermissionGroup {
  id String @id @default(uuid())

  // Nome do grupo (ex: "Gerente de Estoque", "Vendedor")
  name String @db.VarChar(128)

  // Slug para uso programático
  slug String @db.VarChar(128)

  // Descrição do grupo
  description String? @db.Text

  // Se é um grupo do sistema (não pode ser deletado)
  isSystem Boolean @default(false) @map("is_system")

  // Se o grupo está ativo
  isActive Boolean @default(true) @map("is_active")

  // Cor para UI (opcional)
  color String? @db.VarChar(7) // hex color

  // Prioridade (para resolver conflitos)
  priority Int @default(0)

  // Grupo pai (para herança)
  parentId String? @map("parent_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  parent      PermissionGroup?            @relation("GroupHierarchy", fields: [parentId], references: [id])
  children    PermissionGroup[]           @relation("GroupHierarchy")
  permissions PermissionGroupPermission[]
  users       UserPermissionGroup[]

  @@unique([name, deletedAt], name: "permission_groups_name_unique_active")
  @@unique([slug, deletedAt], name: "permission_groups_slug_unique_active")
  @@index([slug])
  @@index([isActive])
  @@index([parentId])
  @@map("permission_groups")
}

/// Relacionamento entre Grupos e Permissões
model PermissionGroupPermission {
  id String @id @default(uuid())

  groupId      String @map("group_id")
  permissionId String @map("permission_id")

  // Tipo de acesso (allow ou deny)
  // Deny tem precedência sobre allow
  effect String @default("allow") @db.VarChar(10) // allow, deny

  // Condições para aplicar a permissão (JSON com regras ABAC)
  conditions Json? @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  group      PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
  @@map("permission_group_permissions")
}

/// Relacionamento entre Usuários e Grupos de Permissões
model UserPermissionGroup {
  id String @id @default(uuid())

  userId  String @map("user_id")
  groupId String @map("group_id")

  // Data de expiração (opcional, para acesso temporário)
  expiresAt DateTime? @map("expires_at")

  // Quem concedeu o acesso
  grantedBy String? @map("granted_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  group   PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  granter User?           @relation("GrantedPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@index([expiresAt])
  @@map("user_permission_groups")
}

/// Permissões atribuídas diretamente a usuários (sem passar por grupos)
model UserDirectPermission {
  id String @id @default(uuid())

  userId       String @map("user_id")
  permissionId String @map("permission_id")

  // Tipo de acesso (allow ou deny)
  // Deny tem precedência sobre allow
  effect String @default("allow") @db.VarChar(10) // allow, deny

  // Condições para aplicar a permissão (JSON com regras ABAC)
  conditions Json? @default("{}")

  // Data de expiração (opcional, para acesso temporário)
  expiresAt DateTime? @map("expires_at")

  // Quem concedeu a permissão
  grantedBy String? @map("granted_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user       User       @relation("UserDirectPermissions", fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granter    User?      @relation("GrantedDirectPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt])
  @@index([effect])
  @@map("user_direct_permissions")
}

/// Log de verificações de permissão (auditoria)
model PermissionAuditLog {
  id String @id @default(uuid())

  userId         String @map("user_id")
  permissionCode String @map("permission_code") @db.VarChar(128)

  // Resultado da verificação
  allowed Boolean

  // Motivo (qual regra permitiu/negou)
  reason String? @db.VarChar(512)

  // Contexto da requisição
  resource   String? @db.VarChar(64)
  resourceId String? @map("resource_id")
  action     String? @db.VarChar(64)

  // Metadados da requisição
  ip        String? @db.VarChar(64)
  userAgent String? @map("user_agent") @db.VarChar(512)
  endpoint  String? @db.VarChar(256)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([permissionCode])
  @@index([allowed])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("permission_audit_logs")
}

// ===============================================
// INVENTORY MANAGEMENT MODULE
// ===============================================

// --- Enums ---

enum UnitOfMeasure {
  METERS
  KILOGRAMS
  UNITS
}

enum MovementType {
  SALE
  PRODUCTION
  SAMPLE
  LOSS
  TRANSFER
  INVENTORY_ADJUSTMENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  PRICE_CHANGE
  STOCK_ADJUSTMENT
  STATUS_CHANGE
  PERMISSION_GRANT
  PERMISSION_REVOKE
  EXPORT
  IMPORT
  SYNC
  OTHER
}

enum AuditEntity {
  // Auth & Users
  USER
  USER_PROFILE
  SESSION
  REFRESH_TOKEN

  // RBAC
  PERMISSION
  PERMISSION_GROUP
  PERMISSION_GROUP_PERMISSION
  USER_PERMISSION_GROUP
  USER_DIRECT_PERMISSION

  // Stock Management
  PRODUCT
  VARIANT
  ITEM
  CATEGORY
  SUPPLIER
  MANUFACTURER
  LOCATION
  TEMPLATE
  ITEM_MOVEMENT
  PRODUCT_CATEGORY
  VARIANT_PRICE_HISTORY
  TAG
  PRODUCT_TAG
  VARIANT_IMAGE
  PURCHASE_ORDER
  PURCHASE_ORDER_ITEM
  UNIT_CONVERSION
  STOCK_SNAPSHOT
  VARIANT_SUPPLIER_CODE
  VARIANT_PROMOTION

  // Sales
  CUSTOMER
  SALES_ORDER
  SALES_ORDER_ITEM
  ITEM_RESERVATION

  // Alerts & Notifications
  ALERT
  NOTIFICATION
  NOTIFICATION_TEMPLATE
  NOTIFICATION_PREFERENCE

  // Comments
  COMMENT

  // Requests
  REQUEST
  REQUEST_ATTACHMENT
  REQUEST_COMMENT
  REQUEST_HISTORY

  // HR
  EMPLOYEE
  DEPARTMENT
  POSITION
  TIME_ENTRY
  WORK_SCHEDULE
  OVERTIME
  TIME_BANK
  ABSENCE
  VACATION_PERIOD

  // Payroll
  PAYROLL
  PAYROLL_ITEM
  BONUS
  DEDUCTION

  // System
  OTHER
}

enum AuditModule {
  CORE
  AUTH
  RBAC
  STOCK
  SALES
  HR
  PAYROLL
  REQUESTS
  NOTIFICATIONS
  SYSTEM
  OTHER
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  DISCONTINUED
  OUT_OF_STOCK
}

enum ItemStatus {
  AVAILABLE
  RESERVED
  IN_TRANSIT
  DAMAGED
  EXPIRED
  DISPOSED
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  EXPIRING_SOON
  EXPIRED
  PRICE_CHANGE
  REORDER_POINT
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
}

enum LocationType {
  WAREHOUSE
  ZONE
  AISLE
  SHELF
  BIN
  OTHER
}

enum CustomerType {
  INDIVIDUAL
  BUSINESS
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

// --- Workflow Notifications Enums ---

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// --- Entidades ---

model Supplier {
  id             String  @id @default(uuid())
  sequentialCode Int     @default(autoincrement()) @map("sequential_code")
  name           String  @db.VarChar(128)
  cnpj           String? @db.VarChar(18)
  taxId          String? @map("tax_id") @db.VarChar(32) // Inscrição Estadual
  contact        String? @db.VarChar(128)

  // Contato
  email   String? @db.VarChar(254)
  phone   String? @db.VarChar(20)
  website String? @db.VarChar(512)

  // Endereço
  address String? @db.VarChar(256)
  city    String? @db.VarChar(128)
  state   String? @db.VarChar(2) // UF
  zipCode String? @map("zip_code") @db.VarChar(10)
  country String? @db.VarChar(64)

  // Gestão Comercial
  paymentTerms String?  @map("payment_terms") @db.VarChar(256)
  rating       Decimal? @db.Decimal(3, 2) // 0.00 a 5.00
  isActive     Boolean  @default(true) @map("is_active")
  notes        String?  @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  products             Product[]
  purchaseOrders       PurchaseOrder[]
  variantSupplierCodes VariantSupplierCode[]

  @@unique([cnpj, deletedAt], name: "suppliers_cnpj_unique_active")
  @@index([sequentialCode])
  @@index([isActive])
  @@index([rating])
  @@map("suppliers")
}

model Manufacturer {
  id      String  @id @default(uuid())
  name    String  @db.VarChar(128)
  country String? @db.VarChar(64)

  // Contato
  email   String? @db.VarChar(254)
  phone   String? @db.VarChar(20)
  website String? @db.VarChar(512)

  // Endereço
  address String? @db.VarChar(256)
  city    String? @db.VarChar(128)
  state   String? @db.VarChar(64)
  zipCode String? @map("zip_code") @db.VarChar(10)

  // Gestão
  isActive Boolean  @default(true) @map("is_active")
  notes    String?  @db.Text
  rating   Decimal? @db.Decimal(3, 2) // 0.00 a 5.00

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  products Product[]

  @@index([isActive])
  @@index([rating])
  @@map("manufacturers")
}

model Category {
  id           String    @id @default(uuid())
  name         String    @db.VarChar(128)
  slug         String    @db.VarChar(128)
  description  String?   @db.VarChar(500)
  parentId     String?   @map("parent_id")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  parent            Category?         @relation("SubCategories", fields: [parentId], references: [id])
  subCategories     Category[]        @relation("SubCategories")
  productCategories ProductCategory[]

  @@unique([slug, deletedAt], name: "categories_slug_unique_active")
  @@index([parentId, deletedAt])
  @@map("categories")
}

model Location {
  id          String       @id @default(uuid())
  code        String       @db.VarChar(5)
  titulo      String       @db.VarChar(256)
  label       String?      @db.VarChar(128)
  type        LocationType @map("location_type")
  parentId    String?      @map("parent_id")
  totalChilds Int          @default(0) @map("total_childs")

  // Capacidade
  capacity         Decimal? @db.Decimal(10, 3)
  currentOccupancy Decimal? @default(0) @map("current_occupancy") @db.Decimal(10, 3)
  isActive         Boolean  @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  parent         Location?       @relation("SubLocations", fields: [parentId], references: [id])
  subLocations   Location[]      @relation("SubLocations")
  items          Item[]
  stockSnapshots StockSnapshot[]

  @@index([isActive])
  @@index([type])
  @@map("locations")
}

// --- Hierarquia Principal de Estoque ---

model Template {
  id                String        @id @default(uuid())
  name              String        @db.VarChar(128)
  unitOfMeasure     UnitOfMeasure @default(UNITS) @map("unit_of_measure")
  productAttributes Json          @default("{}") @map("product_attributes")
  variantAttributes Json          @default("{}") @map("variant_attributes")
  itemAttributes    Json          @default("{}") @map("item_attributes")
  careLabel         Json?         @map("care_label") // Etiqueta de conservação: { washing, drying, ironing, bleaching, dryClean, composition }
  sequentialCode    Int           @default(autoincrement()) @map("sequential_code")
  isActive          Boolean       @default(true) @map("is_active")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  products Product[]

  @@unique([name, deletedAt], name: "templates_name_unique_active")
  @@index([sequentialCode])
  @@index([isActive])
  @@map("templates")
}

model Product {
  id             String        @id @default(uuid())
  name           String        @db.VarChar(256)
  code           String?       @db.VarChar(64) // Opcional, gerado automaticamente se não informado
  fullCode       String?       @map("full_code") @db.VarChar(32) // Código completo: Supplier.Product (ex: 23.6)
  sequentialCode Int           @default(autoincrement()) @map("sequential_code")
  description    String?       @db.Text
  status         ProductStatus @default(ACTIVE)
  attributes     Json          @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  deletedAt      DateTime?     @map("deleted_at")

  templateId     String  @map("template_id")
  supplierId     String? @map("supplier_id")
  manufacturerId String? @map("manufacturer_id")

  template          Template          @relation(fields: [templateId], references: [id])
  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  manufacturer      Manufacturer?     @relation(fields: [manufacturerId], references: [id])
  variants          Variant[]
  productCategories ProductCategory[]
  productTags       ProductTag[]

  @@unique([code, deletedAt], name: "products_code_unique_active")
  @@unique([fullCode, deletedAt], name: "products_fullCode_unique_active")
  @@index([templateId])
  @@index([supplierId])
  @@index([manufacturerId])
  @@index([status])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([code, deletedAt])
  @@index([name, deletedAt])
  @@map("products")
}

model Variant {
  id             String  @id @default(uuid())
  sku            String? @db.VarChar(64) // Opcional, gerado automaticamente se não informado
  fullCode       String? @map("full_code") @db.VarChar(32) // Código completo: Supplier.Product.Variant (ex: 23.6.23)
  sequentialCode Int     @default(autoincrement()) @map("sequential_code")
  name           String  @db.VarChar(256)
  price          Decimal @default(0) @db.Decimal(10, 2)
  imageUrl       String? @map("image_url") @db.VarChar(512)
  attributes     Json    @default("{}")
  isActive       Boolean @default(true) @map("is_active")

  // Preço e Margem
  costPrice    Decimal? @map("cost_price") @db.Decimal(10, 2)
  profitMargin Decimal? @map("profit_margin") @db.Decimal(5, 2) // Percentual

  // Códigos de Barras
  barcode String? @db.VarChar(128)
  qrCode  String? @map("qr_code") @db.VarChar(512)
  eanCode String? @map("ean_code") @db.VarChar(13)
  upcCode String? @map("upc_code") @db.VarChar(12)

  // Cores
  colorHex     String? @map("color_hex") @db.VarChar(7) // Formato hex: #FF5733
  colorPantone String? @map("color_pantone") @db.VarChar(32) // Ex: "PMS 185 C"

  // Controle de Estoque
  minStock        Decimal? @map("min_stock") @db.Decimal(10, 3)
  maxStock        Decimal? @map("max_stock") @db.Decimal(10, 3)
  reorderPoint    Decimal? @map("reorder_point") @db.Decimal(10, 3)
  reorderQuantity Decimal? @map("reorder_quantity") @db.Decimal(10, 3)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  items              Item[]
  priceHistory       VariantPriceHistory[]
  variantImages      VariantImage[]
  unitConversions    UnitConversion[]
  stockSnapshots     StockSnapshot[]
  purchaseOrderItems PurchaseOrderItem[]
  salesOrderItems    SalesOrderItem[]
  variantPromotions  VariantPromotion[]
  supplierCodes      VariantSupplierCode[]

  @@unique([sku, deletedAt], name: "variants_sku_unique_active")
  @@unique([fullCode, deletedAt], name: "variants_fullCode_unique_active")
  @@unique([barcode, deletedAt], name: "variants_barcode_unique_active")
  @@unique([eanCode, deletedAt], name: "variants_eanCode_unique_active")
  @@unique([upcCode, deletedAt], name: "variants_upcCode_unique_active")
  @@index([productId])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([isActive])
  @@index([barcode])
  @@index([eanCode])
  @@index([upcCode])
  @@map("variants")
}

model Item {
  id              String     @id @default(uuid())
  uniqueCode      String?    @map("unique_code") @db.VarChar(128) // Opcional, gerado automaticamente
  fullCode        String?    @map("full_code") @db.VarChar(32) // Código completo: Supplier.Product.Variant-Seq (ex: 23.6.23-1)
  sequentialCode  Int        @default(autoincrement()) @map("sequential_code")
  initialQuantity Decimal    @map("initial_quantity") @db.Decimal(10, 3)
  currentQuantity Decimal    @map("current_quantity") @db.Decimal(10, 3)
  unitCost        Decimal?   @map("unit_cost") @db.Decimal(10, 2) // Custo unitário de aquisição
  status          ItemStatus @default(AVAILABLE)
  entryDate       DateTime   @default(now()) @map("entry_date")
  attributes      Json       @default("{}")

  // Lote e Validade
  batchNumber       String?   @map("batch_number") @db.VarChar(64)
  manufacturingDate DateTime? @map("manufacturing_date") @db.Date
  expiryDate        DateTime? @map("expiry_date") @db.Date

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  variantId  String  @map("variant_id")
  locationId String? @map("location_id") // Opcional, pode ser definido depois

  variant      Variant           @relation(fields: [variantId], references: [id])
  location     Location?         @relation(fields: [locationId], references: [id])
  movements    ItemMovement[]
  reservations ItemReservation[]

  @@unique([uniqueCode, deletedAt], name: "items_uniqueCode_unique_active")
  @@unique([fullCode, deletedAt], name: "items_fullCode_unique_active")
  @@index([variantId])
  @@index([locationId])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([batchNumber])
  @@index([expiryDate])
  @@index([status])
  @@index([variantId, locationId])
  @@index([expiryDate, deletedAt])
  @@index([batchNumber, variantId])
  @@map("items")
}

model ItemMovement {
  id             String       @id @default(uuid())
  quantity       Decimal      @db.Decimal(10, 3)
  quantityBefore Decimal?     @map("quantity_before") @db.Decimal(10, 3)
  quantityAfter  Decimal?     @map("quantity_after") @db.Decimal(10, 3)
  movementType   MovementType @map("movement_type")
  reasonCode     String?      @map("reason_code") @db.VarChar(64)
  destinationRef String?      @map("destination_ref") @db.VarChar(128) // Ex: Pedido de Venda #123, OP #456
  batchNumber    String?      @map("batch_number") @db.VarChar(64)
  notes          String?      @db.Text
  createdAt      DateTime     @default(now()) @map("created_at")

  itemId       String  @map("item_id")
  userId       String  @map("user_id")
  approvedBy   String? @map("approved_by")
  salesOrderId String? @map("sales_order_id")

  item       Item        @relation(fields: [itemId], references: [id])
  user       User        @relation(fields: [userId], references: [id])
  approver   User?       @relation("ApprovedMovements", fields: [approvedBy], references: [id])
  salesOrder SalesOrder? @relation(fields: [salesOrderId], references: [id])

  @@index([itemId])
  @@index([userId])
  @@index([approvedBy])
  @@index([movementType])
  @@index([batchNumber])
  @@index([salesOrderId])
  @@index([itemId, createdAt])
  @@index([userId, movementType])
  @@index([createdAt(sort: Desc)])
  @@map("item_movements")
}

// --- Tabelas de Relacionamento e Histórico ---

model ProductCategory {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  categoryId String   @map("category_id")
  order      Int      @default(0) // Ordem de exibição
  featured   Boolean  @default(false) // Categoria em destaque para este produto
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([featured])
  @@map("product_categories")
}

model VariantPriceHistory {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  oldPrice  Decimal? @map("old_price") @db.Decimal(10, 2)
  newPrice  Decimal  @map("new_price") @db.Decimal(10, 2)
  reason    String?  @db.VarChar(256)
  createdAt DateTime @default(now()) @map("created_at")

  userId String @map("user_id")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([variantId])
  @@index([userId])
  @@index([createdAt])
  @@map("variant_price_history")
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  entity      AuditEntity
  module      AuditModule // Módulo da entidade
  entityId    String      @map("entity_id") // ID da entidade afetada
  description String?     @db.VarChar(512)
  oldData     Json?       @map("old_data") // Estado anterior (JSON)
  newData     Json?       @map("new_data") // Novo estado (JSON)

  // Request metadata
  ip        String? @db.VarChar(64)
  userAgent String? @map("user_agent") @db.VarChar(512)
  endpoint  String? @db.VarChar(256) // API endpoint chamado
  method    String? @db.VarChar(10) // HTTP method (GET, POST, etc)

  // User info
  userId       String? @map("user_id") // Nullable para ações do sistema
  affectedUser String? @map("affected_user") // Usuário afetado pela ação (quando diferente do executor)

  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at") // Para limpeza automática

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([affectedUser])
  @@index([action])
  @@index([entity])
  @@index([module])
  @@index([entityId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([entity, entityId])
  @@index([module, createdAt])
  @@index([userId, action])
  @@map("audit_logs")
}

// --- Sistema de Tags ---

model Tag {
  id          String    @id @default(uuid())
  name        String    @unique @db.VarChar(64)
  slug        String    @unique @db.VarChar(64)
  color       String?   @db.VarChar(7) // Formato hex: #FF5733
  description String?   @db.VarChar(256)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  productTags ProductTag[]

  @@index([slug])
  @@map("tags")
}

model ProductTag {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

// --- Sistema de Imagens ---

model VariantImage {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  url       String   @db.VarChar(512)
  alt       String?  @db.VarChar(256)
  order     Int      @default(0)
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([isPrimary])
  @@index([variantId, order])
  @@map("variant_images")
}

// --- Sistema de Alertas ---

model Alert {
  id        String        @id @default(uuid())
  type      AlertType
  severity  AlertSeverity @default(MEDIUM)
  entityId  String        @map("entity_id") // ID do item/variant afetado
  message   String        @db.VarChar(512)
  isRead    Boolean       @default(false) @map("is_read")
  createdAt DateTime      @default(now()) @map("created_at")
  readAt    DateTime?     @map("read_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([entityId])
  @@index([severity])
  @@index([userId, isRead])
  @@index([userId, severity, isRead])
  @@map("alerts")
}

// --- Sistema de Pedidos de Compra ---

model PurchaseOrder {
  id           String      @id @default(uuid())
  orderNumber  String      @unique @map("order_number") @db.VarChar(64)
  status       OrderStatus @default(PENDING)
  totalCost    Decimal     @map("total_cost") @db.Decimal(10, 2)
  expectedDate DateTime?   @map("expected_date")
  receivedDate DateTime?   @map("received_date")
  notes        String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  deletedAt    DateTime?   @map("deleted_at")

  supplierId String  @map("supplier_id")
  createdBy  String? @map("created_by")

  supplier Supplier @relation(fields: [supplierId], references: [id])
  creator  User?    @relation("CreatedPurchaseOrders", fields: [createdBy], references: [id])

  items PurchaseOrderItem[]

  @@index([supplierId])
  @@index([status])
  @@index([orderNumber])
  @@index([expectedDate])
  @@index([createdBy])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  variantId String   @map("variant_id")
  quantity  Decimal  @db.Decimal(10, 3)
  unitCost  Decimal  @map("unit_cost") @db.Decimal(10, 2)
  totalCost Decimal  @map("total_cost") @db.Decimal(10, 2)
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  order   PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant       @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
  @@map("purchase_order_items")
}

// --- Sistema de Conversão de Unidades ---

model UnitConversion {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  fromUnit  String   @db.VarChar(32) // Ex: "CAIXA"
  toUnit    String   @db.VarChar(32) // Ex: "UNIDADE"
  factor    Decimal  @db.Decimal(10, 3) // Ex: 12 (1 caixa = 12 unidades)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, fromUnit, toUnit])
  @@index([variantId])
  @@map("unit_conversions")
}

// --- Sistema de Snapshots de Estoque ---

model StockSnapshot {
  id           String   @id @default(uuid())
  variantId    String   @map("variant_id")
  locationId   String?  @map("location_id")
  quantity     Decimal  @db.Decimal(10, 3)
  totalValue   Decimal  @map("total_value") @db.Decimal(12, 2)
  snapshotDate DateTime @map("snapshot_date")
  notes        String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  variant  Variant   @relation(fields: [variantId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  @@index([variantId])
  @@index([locationId])
  @@index([snapshotDate])
  @@index([variantId, snapshotDate])
  @@map("stock_snapshots")
}

// --- Sistema de Clientes e Vendas ---

model Customer {
  id        String       @id @default(uuid())
  name      String       @db.VarChar(128)
  type      CustomerType @default(INDIVIDUAL)
  document  String?      @db.VarChar(18) // CPF ou CNPJ
  email     String?      @db.VarChar(254)
  phone     String?      @db.VarChar(20)
  address   String?      @db.VarChar(256)
  city      String?      @db.VarChar(128)
  state     String?      @db.VarChar(2) // UF
  zipCode   String?      @map("zip_code") @db.VarChar(10)
  country   String?      @db.VarChar(64)
  notes     String?      @db.Text
  isActive  Boolean      @default(true) @map("is_active")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  deletedAt DateTime?    @map("deleted_at")

  salesOrders SalesOrder[]

  @@unique([document, deletedAt], name: "customers_document_unique_active")
  @@index([document])
  @@index([email])
  @@index([isActive])
  @@index([type])
  @@map("customers")
}

model SalesOrder {
  id          String      @id @default(uuid())
  orderNumber String      @map("order_number") @db.VarChar(64)
  status      OrderStatus @default(PENDING)
  totalPrice  Decimal     @map("total_price") @db.Decimal(10, 2)
  discount    Decimal?    @default(0) @db.Decimal(10, 2)
  finalPrice  Decimal     @map("final_price") @db.Decimal(10, 2)
  notes       String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  deletedAt   DateTime?   @map("deleted_at")

  customerId String  @map("customer_id")
  createdBy  String? @map("created_by")

  customer      Customer         @relation(fields: [customerId], references: [id])
  creator       User?            @relation("CreatedSalesOrders", fields: [createdBy], references: [id])
  items         SalesOrderItem[]
  itemMovements ItemMovement[]

  @@unique([orderNumber, deletedAt], name: "sales_orders_order_number_unique_active")
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdBy])
  @@index([createdAt])
  @@map("sales_orders")
}

model SalesOrderItem {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  variantId  String   @map("variant_id")
  quantity   Decimal  @db.Decimal(10, 3)
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount   Decimal? @default(0) @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant    @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
  @@map("sales_order_items")
}

// --- Sistema de Reservas ---

model ItemReservation {
  id         String    @id @default(uuid())
  itemId     String    @map("item_id")
  quantity   Decimal   @db.Decimal(10, 3)
  reason     String?   @db.VarChar(256)
  reference  String?   @db.VarChar(128) // Referência externa (pedido, etc)
  expiresAt  DateTime  @map("expires_at")
  releasedAt DateTime? @map("released_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  item   Item   @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([userId])
  @@index([expiresAt])
  @@index([itemId, expiresAt])
  @@map("item_reservations")
}

// --- Sistema de Códigos de Fornecedor ---

model VariantSupplierCode {
  id         String   @id @default(uuid())
  variantId  String   @map("variant_id")
  supplierId String   @map("supplier_id")
  code       String   @db.VarChar(64) // Código do fornecedor para este variant
  isPrimary  Boolean  @default(false) @map("is_primary")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  variant  Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@unique([variantId, supplierId])
  @@unique([supplierId, code])
  @@index([variantId])
  @@index([supplierId])
  @@index([code])
  @@map("variant_supplier_codes")
}

// --- Sistema de Promoções ---

model VariantPromotion {
  id            String       @id @default(uuid())
  variantId     String       @map("variant_id")
  name          String       @db.VarChar(128)
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  startDate     DateTime     @map("start_date")
  endDate       DateTime     @map("end_date")
  isActive      Boolean      @default(true) @map("is_active")
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  deletedAt     DateTime?    @map("deleted_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@index([variantId, startDate, endDate])
  @@map("variant_promotions")
}

// --- Sistema de Comentários ---

model Comment {
  id              String    @id @default(uuid())
  entityType      String    @db.VarChar(32) // "PRODUCT", "VARIANT", "ITEM", etc
  entityId        String    @db.VarChar(36) // UUID da entidade
  content         String    @db.Text
  parentCommentId String?   @map("parent_comment_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  userId  String    @map("user_id")
  user    User      @relation(fields: [userId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([entityType, entityId])
  @@index([parentCommentId])
  @@index([createdAt])
  @@map("comments")
}

// --- Sistema de Preferências de Notificação ---

model NotificationPreference {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  alertType AlertType           @map("alert_type")
  channel   NotificationChannel
  isEnabled Boolean             @default(true) @map("is_enabled")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")
  deletedAt DateTime?           @map("deleted_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, alertType, channel])
  @@index([userId])
  @@index([alertType])
  @@map("notification_preferences")
}

// --- Workflow Notifications System ---

model NotificationTemplate {
  id              String               @id @default(uuid())
  code            String               @unique @db.VarChar(64)
  name            String               @db.VarChar(128)
  titleTemplate   String               @map("title_template") @db.VarChar(256)
  messageTemplate String               @map("message_template") @db.Text
  defaultChannel  NotificationChannel  @map("default_channel")
  defaultPriority NotificationPriority @default(NORMAL) @map("default_priority")
  isActive        Boolean              @default(true) @map("is_active")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  deletedAt       DateTime?            @map("deleted_at")

  @@index([code])
  @@index([isActive])
  @@map("notification_templates")
}

model Notification {
  id           String               @id @default(uuid())
  userId       String               @map("user_id")
  title        String               @db.VarChar(256)
  message      String               @db.Text
  type         NotificationType
  priority     NotificationPriority @default(NORMAL)
  channel      NotificationChannel
  actionUrl    String?              @map("action_url") @db.VarChar(512)
  actionText   String?              @map("action_text") @db.VarChar(64)
  entityType   String?              @map("entity_type") @db.VarChar(32)
  entityId     String?              @map("entity_id") @db.VarChar(36)
  isRead       Boolean              @default(false) @map("is_read")
  isSent       Boolean              @default(false) @map("is_sent")
  scheduledFor DateTime?            @map("scheduled_for")
  readAt       DateTime?            @map("read_at")
  sentAt       DateTime?            @map("sent_at")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  deletedAt    DateTime?            @map("deleted_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([priority])
  @@index([channel])
  @@index([entityType, entityId])
  @@index([scheduledFor])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ===============================================
// REQUEST SYSTEM MODULE
// ===============================================

enum RequestType {
  ACCESS_REQUEST // Requisição de acesso
  PURCHASE_REQUEST // Requisição de compra
  APPROVAL_REQUEST // Requisição de aprovação
  ACTION_REQUEST // Requisição de ação
  CHANGE_REQUEST // Requisição de mudança
  CUSTOM // Customizado
}

enum RequestStatus {
  DRAFT // Rascunho
  SUBMITTED // Submetida
  IN_PROGRESS // Em progresso
  PENDING_INFO // Aguardando informações
  APPROVED // Aprovada
  REJECTED // Rejeitada
  CANCELLED // Cancelada
  COMPLETED // Concluída
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestTargetType {
  USER // Requisição para usuário específico
  GROUP // Requisição para grupo (ex: gestores)
  ROLE // Requisição para role (ADMIN, MANAGER)
}

model Request {
  id String @id @default(uuid())

  // Identificação
  title       String      @db.VarChar(200)
  description String      @db.Text
  type        RequestType
  category    String?     @db.VarChar(100) // "purchase", "access", "hr", etc

  // Status e Prioridade
  status   RequestStatus   @default(SUBMITTED)
  priority RequestPriority @default(MEDIUM)

  // Solicitante
  requesterId String @map("requester_id")
  requester   User   @relation("RequestsCreated", fields: [requesterId], references: [id])

  // Destinatário (pode ser usuário, grupo ou role)
  targetType RequestTargetType @map("target_type")
  targetId   String?           @map("target_id") // ID do usuário ou grupo
  targetRole Role?             @map("target_role") // Se for por role

  // Atribuído a (responsável atual)
  assignedToId String? @map("assigned_to_id")
  assignedTo   User?   @relation("RequestsAssigned", fields: [assignedToId], references: [id])

  // SLA e Prazos
  dueDate     DateTime? @map("due_date")
  slaDeadline DateTime? @map("sla_deadline")

  // Dados flexíveis (JSON)
  metadata Json @default("{}")

  // Integração com Aprovação
  requiresApproval Boolean @default(false) @map("requires_approval")
  approvalId       String? @unique @map("approval_id")

  // Timestamps
  submittedAt DateTime? @map("submitted_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  attachments RequestAttachment[]
  comments    RequestComment[]
  history     RequestHistory[]

  @@index([requesterId])
  @@index([assignedToId])
  @@index([status])
  @@index([type, category])
  @@index([dueDate])
  @@index([createdAt])
  @@map("requests")
}

model RequestAttachment {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  fileName     String   @map("file_name") @db.VarChar(255)
  filePath     String   @map("file_path") @db.VarChar(512)
  fileSize     Int      @map("file_size")
  mimeType     String   @map("mime_type") @db.VarChar(100)
  uploadedById String   @map("uploaded_by_id")
  uploadedBy   User     @relation("UploadedAttachments", fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([requestId])
  @@map("request_attachments")
}

model RequestComment {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  authorId   String    @map("author_id")
  author     User      @relation("RequestComments", fields: [authorId], references: [id])
  content    String    @db.Text
  isInternal Boolean   @default(false) @map("is_internal") // Comentário interno (não visível para solicitante)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  @@index([requestId])
  @@index([authorId])
  @@map("request_comments")
}

model RequestHistory {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  action        String   @db.VarChar(100) // "created", "assigned", "status_changed", etc
  description   String   @db.Text
  performedById String   @map("performed_by_id")
  performedBy   User     @relation("RequestHistoryActions", fields: [performedById], references: [id])
  oldValue      Json?    @map("old_value")
  newValue      Json?    @map("new_value")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([requestId])
  @@index([createdAt])
  @@map("request_history")
}

// ===============================================
// HUMAN RESOURCES MODULE
// ===============================================

// --- Enums ---

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  VACATION
  SUSPENDED
  TERMINATED
}

enum ContractType {
  CLT
  PJ
  INTERN
  TEMPORARY
  APPRENTICE
}

enum WorkRegime {
  FULL_TIME
  PART_TIME
  HOURLY
  SHIFT
  FLEXIBLE
}

// --- Entidades ---

model Employee {
  id String @id @default(uuid())

  // Identificação
  registrationNumber String @unique @map("registration_number") @db.VarChar(32)

  // Vinculação com usuário (opcional)
  userId String? @unique @map("user_id")

  // Dados pessoais
  fullName      String    @db.VarChar(256)
  socialName    String?   @db.VarChar(256)
  birthDate     DateTime? @map("birth_date")
  gender        String?   @db.VarChar(32)
  maritalStatus String?   @db.VarChar(32)
  nationality   String?   @db.VarChar(64)
  birthPlace    String?   @db.VarChar(128)

  // Documentos
  cpf         String    @unique @db.VarChar(14)
  rg          String?   @db.VarChar(20)
  rgIssuer    String?   @map("rg_issuer") @db.VarChar(32)
  rgIssueDate DateTime? @map("rg_issue_date")
  pis         String?   @unique @db.VarChar(14)
  ctpsNumber  String?   @db.VarChar(32)
  ctpsSeries  String?   @db.VarChar(16)
  ctpsState   String?   @db.VarChar(2)
  voterTitle  String?   @db.VarChar(16)
  militaryDoc String?   @db.VarChar(32)

  // Contato
  email            String? @db.VarChar(254)
  personalEmail    String? @map("personal_email") @db.VarChar(254)
  phone            String? @db.VarChar(20)
  mobilePhone      String? @map("mobile_phone") @db.VarChar(20)
  emergencyContact String? @map("emergency_contact") @db.VarChar(128)
  emergencyPhone   String? @map("emergency_phone") @db.VarChar(20)

  // Endereço
  address       String? @db.VarChar(256)
  addressNumber String? @db.VarChar(16)
  complement    String? @db.VarChar(128)
  neighborhood  String? @db.VarChar(128)
  city          String? @db.VarChar(128)
  state         String? @db.VarChar(2)
  zipCode       String? @map("zip_code") @db.VarChar(10)
  country       String  @default("Brasil") @db.VarChar(64)

  // Dados bancários
  bankCode        String? @db.VarChar(8)
  bankName        String? @db.VarChar(128)
  bankAgency      String? @db.VarChar(16)
  bankAccount     String? @db.VarChar(32)
  bankAccountType String? @db.VarChar(32)
  pixKey          String? @db.VarChar(128)

  // Vínculo empregatício
  departmentId    String?        @map("department_id")
  positionId      String?        @map("position_id")
  supervisorId    String?        @map("supervisor_id")
  hireDate        DateTime       @map("hire_date")
  terminationDate DateTime?      @map("termination_date")
  status          EmployeeStatus @default(ACTIVE)
  baseSalary      Decimal        @map("base_salary") @db.Decimal(10, 2)
  contractType    ContractType   @map("contract_type")
  workRegime      WorkRegime     @map("work_regime")
  weeklyHours     Decimal        @map("weekly_hours") @db.Decimal(5, 2) // Horas semanais
  photoUrl        String?        @map("photo_url") @db.VarChar(512)

  // Metadados flexíveis
  metadata Json @default("{}")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User?       @relation(fields: [userId], references: [id])
  department   Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  position     Position?   @relation(fields: [positionId], references: [id])
  supervisor   Employee?   @relation("EmployeeSupervisor", fields: [supervisorId], references: [id])
  subordinates Employee[]  @relation("EmployeeSupervisor")

  // Time Control
  timeEntries TimeEntry[]

  // Absences
  absences Absence[]

  // Payroll
  payrollItems PayrollItem[]

  // Overtime
  overtime Overtime[]

  // Time Bank
  timeBanks TimeBank[]

  // Vacation
  vacationPeriods VacationPeriod[]

  // Bonuses
  bonuses Bonus[]

  // Deductions
  deductions Deduction[]

  // Management
  managedDepartments Department[] @relation("DepartmentManager")

  @@index([userId])
  @@index([cpf])
  @@index([registrationNumber])
  @@index([departmentId])
  @@index([positionId])
  @@index([supervisorId])
  @@index([status])
  @@index([hireDate])
  @@index([terminationDate])
  @@index([deletedAt])
  @@map("employees")
}

model Department {
  id String @id @default(uuid())

  name        String  @db.VarChar(128)
  code        String  @unique @db.VarChar(32)
  description String? @db.Text
  parentId    String? @map("parent_id")
  managerId   String? @map("manager_id")
  isActive    Boolean @default(true) @map("is_active")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent    Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DepartmentHierarchy")
  manager   Employee?    @relation("DepartmentManager", fields: [managerId], references: [id])
  positions Position[]
  employees Employee[]   @relation("DepartmentEmployees")

  @@index([code])
  @@index([parentId])
  @@index([managerId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("departments")
}

model Position {
  id String @id @default(uuid())

  name         String   @db.VarChar(128)
  code         String   @unique @db.VarChar(32)
  description  String?  @db.Text
  departmentId String?  @map("department_id")
  level        Int      @default(1)
  minSalary    Decimal? @map("min_salary") @db.Decimal(10, 2)
  maxSalary    Decimal? @map("max_salary") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  department Department? @relation(fields: [departmentId], references: [id])
  employees  Employee[]

  @@index([code])
  @@index([departmentId])
  @@index([level])
  @@index([isActive])
  @@index([deletedAt])
  @@map("positions")
}

// ===============================================
// TIME CONTROL MODULE
// ===============================================

enum TimeEntryType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
  OVERTIME_START
  OVERTIME_END
}

model TimeEntry {
  id String @id @default(uuid())

  employeeId String        @map("employee_id")
  entryType  TimeEntryType @map("entry_type")
  timestamp  DateTime
  latitude   Decimal?      @db.Decimal(10, 8)
  longitude  Decimal?      @db.Decimal(11, 8)
  ipAddress  String?       @map("ip_address") @db.VarChar(64)
  notes      String?       @db.Text

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([timestamp])
  @@index([entryType])
  @@index([employeeId, timestamp])
  @@map("time_entries")
}

model WorkSchedule {
  id String @id @default(uuid())

  name           String  @db.VarChar(128)
  description    String? @db.Text
  mondayStart    String? @map("monday_start") @db.VarChar(5) // HH:MM format
  mondayEnd      String? @map("monday_end") @db.VarChar(5)
  tuesdayStart   String? @map("tuesday_start") @db.VarChar(5)
  tuesdayEnd     String? @map("tuesday_end") @db.VarChar(5)
  wednesdayStart String? @map("wednesday_start") @db.VarChar(5)
  wednesdayEnd   String? @map("wednesday_end") @db.VarChar(5)
  thursdayStart  String? @map("thursday_start") @db.VarChar(5)
  thursdayEnd    String? @map("thursday_end") @db.VarChar(5)
  fridayStart    String? @map("friday_start") @db.VarChar(5)
  fridayEnd      String? @map("friday_end") @db.VarChar(5)
  saturdayStart  String? @map("saturday_start") @db.VarChar(5)
  saturdayEnd    String? @map("saturday_end") @db.VarChar(5)
  sundayStart    String? @map("sunday_start") @db.VarChar(5)
  sundayEnd      String? @map("sunday_end") @db.VarChar(5)

  breakDuration Int     @default(60) @map("break_duration") // Minutos
  isActive      Boolean @default(true) @map("is_active")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("work_schedules")
}

model Overtime {
  id String @id @default(uuid())

  employeeId String    @map("employee_id")
  date       DateTime
  hours      Decimal   @db.Decimal(5, 2)
  reason     String    @db.Text
  approved   Boolean   @default(false)
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation(fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([date])
  @@index([approved])
  @@map("overtime")
}

model TimeBank {
  id String @id @default(uuid())

  employeeId String  @map("employee_id")
  balance    Decimal @db.Decimal(8, 2) // Saldo em horas
  year       Int

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, year])
  @@index([employeeId])
  @@map("time_banks")
}

// ===============================================
// ABSENCES MODULE
// ===============================================

enum AbsenceType {
  VACATION
  SICK_LEAVE
  PERSONAL_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
  BEREAVEMENT_LEAVE
  WEDDING_LEAVE
  MEDICAL_APPOINTMENT
  JURY_DUTY
  UNPAID_LEAVE
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  IN_PROGRESS
  COMPLETED
}

model Absence {
  id String @id @default(uuid())

  employeeId           String        @map("employee_id")
  type                 AbsenceType
  status               AbsenceStatus @default(PENDING)
  startDate            DateTime      @map("start_date")
  endDate              DateTime      @map("end_date")
  totalDays            Int           @map("total_days") // Total days of absence
  reason               String?       @db.Text
  documentUrl          String?       @map("document_url") @db.VarChar(512) // URL do atestado/documento
  cid                  String?       @db.VarChar(10) // Código CID para atestados médicos
  isPaid               Boolean       @default(true) @map("is_paid")
  isInssResponsibility Boolean       @default(false) @map("is_inss_responsibility") // Para afastamentos > 15 dias
  vacationPeriodId     String?       @map("vacation_period_id") // Para férias
  notes                String?       @db.Text

  // Quem solicitou (pode ser diferente do funcionário)
  requestedBy String? @map("requested_by")

  // Aprovação
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation(fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([type])
  @@index([status])
  @@index([startDate, endDate])
  @@index([vacationPeriodId])
  @@index([deletedAt])
  @@map("absences")
}

model VacationPeriod {
  id String @id @default(uuid())

  employeeId String @map("employee_id")

  // Período Aquisitivo (12 meses de trabalho)
  acquisitionStart DateTime @map("acquisition_start")
  acquisitionEnd   DateTime @map("acquisition_end")

  // Período Concessivo (12 meses para tirar férias)
  concessionStart DateTime @map("concession_start")
  concessionEnd   DateTime @map("concession_end")

  // Dias de direito
  totalDays     Int @default(30) @map("total_days") // Dias totais de direito
  usedDays      Int @default(0) @map("used_days") // Dias já utilizados
  soldDays      Int @default(0) @map("sold_days") // Abono pecuniário (max 10)
  remainingDays Int @default(30) @map("remaining_days") // Saldo disponível

  // Controle de agendamento
  status         String    @default("PENDING") @db.VarChar(32) // PENDING, AVAILABLE, SCHEDULED, IN_PROGRESS, COMPLETED, EXPIRED, SOLD
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")

  notes String? @db.Text

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([acquisitionStart, acquisitionEnd])
  @@index([concessionStart, concessionEnd])
  @@index([deletedAt])
  @@map("vacation_periods")
}

// ===============================================
// PAYROLL MODULE
// ===============================================

enum PayrollStatus {
  DRAFT
  PROCESSING
  CALCULATED
  APPROVED
  PAID
  CANCELLED
}

enum PayrollItemType {
  BASE_SALARY
  BONUS
  COMMISSION
  OVERTIME
  NIGHT_SHIFT
  HAZARD_PAY
  DANGER_PAY
  VACATION_PAY
  THIRTEENTH_SALARY
  HOLIDAY
  INSS
  IRRF
  FGTS
  HEALTH_INSURANCE
  DENTAL_PLAN
  TRANSPORT_VOUCHER
  MEAL_VOUCHER
  OTHER_BENEFIT
  ADVANCE
  LOAN
  OTHER_DEDUCTION
}

model Payroll {
  id String @id @default(uuid())

  referenceMonth  Int           @map("reference_month") // 1-12
  referenceYear   Int           @map("reference_year")
  status          PayrollStatus @default(DRAFT)
  totalGross      Decimal       @map("total_gross") @db.Decimal(12, 2)
  totalDeductions Decimal       @map("total_deductions") @db.Decimal(12, 2)
  totalNet        Decimal       @map("total_net") @db.Decimal(12, 2)

  // Processamento
  processedAt DateTime? @map("processed_at")
  processedBy String?   @map("processed_by")

  // Aprovação
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by")

  // Pagamento
  paidAt DateTime? @map("paid_at")
  paidBy String?   @map("paid_by")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  processor User?         @relation("PayrollProcessor", fields: [processedBy], references: [id])
  approver  User?         @relation("PayrollApprover", fields: [approvedBy], references: [id])
  payer     User?         @relation("PayrollPayer", fields: [paidBy], references: [id])
  items     PayrollItem[]

  @@unique([referenceMonth, referenceYear])
  @@index([status])
  @@index([referenceYear, referenceMonth])
  @@map("payrolls")
}

model PayrollItem {
  id String @id @default(uuid())

  payrollId   String          @map("payroll_id")
  employeeId  String          @map("employee_id")
  type        PayrollItemType
  description String          @db.VarChar(256)
  amount      Decimal         @db.Decimal(10, 2)
  isDeduction Boolean         @default(false) @map("is_deduction")

  // Referências externas
  referenceId   String? @map("reference_id") // ID de overtime, absence, etc
  referenceType String? @map("reference_type") // "overtime", "absence", etc

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payroll  Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([payrollId])
  @@index([employeeId])
  @@index([type])
  @@map("payroll_items")
}

model Bonus {
  id String @id @default(uuid())

  employeeId String   @map("employee_id")
  name       String   @db.VarChar(128)
  amount     Decimal  @db.Decimal(10, 2)
  reason     String   @db.Text
  date       DateTime
  isPaid     Boolean  @default(false) @map("is_paid")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([date])
  @@index([isPaid])
  @@map("bonuses")
}

model Deduction {
  id String @id @default(uuid())

  employeeId         String    @map("employee_id")
  name               String    @db.VarChar(128)
  amount             Decimal   @db.Decimal(10, 2)
  reason             String    @db.Text
  date               DateTime
  isRecurring        Boolean   @default(false) @map("is_recurring")
  installments       Int?      @map("installments")
  currentInstallment Int       @default(0) @map("current_installment")
  isApplied          Boolean   @default(false) @map("is_applied")
  appliedAt          DateTime? @map("applied_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([date])
  @@index([isApplied])
  @@index([isRecurring])
  @@map("deductions")
}

// ===============================================
// ENTERPRISE MODULE
// ===============================================

model Enterprise {
  id String @id @default(uuid())

  // Dados obrigatórios
  legalName String @map("legal_name") @db.VarChar(256)
  cnpj      String @db.VarChar(18)

  // Dados opcionais
  taxRegime     String? @map("tax_regime") @db.VarChar(128)
  phone         String? @db.VarChar(20)
  address       String? @db.VarChar(256)
  addressNumber String? @map("address_number") @db.VarChar(16)
  complement    String? @db.VarChar(128)
  neighborhood  String? @map("neighborhood") @db.VarChar(128)
  city          String? @db.VarChar(128)
  state         String? @db.VarChar(2)
  zipCode       String? @map("zip_code") @db.VarChar(10)
  country       String? @default("Brasil") @db.VarChar(64)
  logoUrl       String? @map("logo_url") @db.VarChar(512)

  // Metadados
  metadata Json @default("{}")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([cnpj, deletedAt], name: "enterprises_cnpj_unique_active")
  @@index([cnpj])
  @@index([legalName])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("enterprises")
}
