// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===============================================
// SIMPLE AUTH MODULE
// ===============================================

// --- Enums ---

enum CompanyStatusEnum {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TaxRegimeEnum {
  SIMPLES
  LUCRO_PRESUMIDO
  LUCRO_REAL
  IMUNE_ISENTA
  OUTROS
}

enum OrganizationType {
  COMPANY // Empresa própria
  SUPPLIER // Fornecedor
  MANUFACTURER // Fabricante
  CUSTOMER // Cliente (futuro)
}

enum OrganizationStatusEnum {
  ACTIVE
  INACTIVE
  SUSPENDED
  BLOCKED
}

enum FinanceCategoryType {
  EXPENSE
  REVENUE
  BOTH
}

enum BankAccountType {
  CHECKING
  SAVINGS
  SALARY
  PAYMENT
  INVESTMENT
  DIGITAL
  OTHER
}

enum BankAccountStatus {
  ACTIVE
  INACTIVE
  CLOSED
}

enum FinanceEntryType {
  PAYABLE
  RECEIVABLE
}

enum FinanceEntryRecurrence {
  SINGLE
  RECURRING
  INSTALLMENT
}

enum FinanceEntryStatus {
  PENDING
  OVERDUE
  PAID
  RECEIVED
  PARTIALLY_PAID
  CANCELLED
  SCHEDULED
}

enum RecurrenceUnit {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

// --- Entidades ---

model User {
  id String @id @default(uuid())

  // Credentials
  username      String? @db.VarChar(32)
  email         String  @db.VarChar(254)
  password_hash String  @db.VarChar(100)

  // Access Control
  lastLoginIp         String?   @map("last_login_ip")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  blockedUntil        DateTime? @map("blocked_until")

  // Recovery
  passwordResetToken   String?   @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")

  // Forced Password Reset
  forcePasswordReset            Boolean   @default(false) @map("force_password_reset")
  forcePasswordResetReason      String?   @map("force_password_reset_reason") @db.VarChar(255)
  forcePasswordResetRequestedBy String?   @map("force_password_reset_requested_by")
  forcePasswordResetRequestedAt DateTime? @map("force_password_reset_requested_at")

  // Multi-Tenant
  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  profile                  UserProfile?
  RefreshToken             RefreshToken[]
  sessions                 Session[]
  tenantUsers              TenantUser[]
  ItemMovement             ItemMovement[]
  ApprovedMovements        ItemMovement[]           @relation("ApprovedMovements")
  AuditLogs                AuditLog[]
  VariantPriceHistory      VariantPriceHistory[]
  Alerts                   Alert[]
  CreatedPurchaseOrders    PurchaseOrder[]          @relation("CreatedPurchaseOrders")
  CreatedSalesOrders       SalesOrder[]             @relation("CreatedSalesOrders")
  ItemReservations         ItemReservation[]
  Comments                 Comment[]
  NotificationPreferences  NotificationPreference[]
  Notifications            Notification[]
  permissionGroups         UserPermissionGroup[]
  grantedPermissions       UserPermissionGroup[]    @relation("GrantedPermissions")
  directPermissions        UserDirectPermission[]   @relation("UserDirectPermissions")
  grantedDirectPermissions UserDirectPermission[]   @relation("GrantedDirectPermissions")
  permissionAuditLogs      PermissionAuditLog[]
  RequestsCreated          Request[]                @relation("RequestsCreated")
  RequestsAssigned         Request[]                @relation("RequestsAssigned")
  UploadedAttachments      RequestAttachment[]      @relation("UploadedAttachments")
  RequestComments          RequestComment[]         @relation("RequestComments")
  RequestHistoryActions    RequestHistory[]         @relation("RequestHistoryActions")

  // HR Relations
  employee Employee?

  // Payroll Relations
  processedPayrolls Payroll[] @relation("PayrollProcessor")
  approvedPayrolls  Payroll[] @relation("PayrollApprover")
  paidPayrolls      Payroll[] @relation("PayrollPayer")

  // Overtime Relations
  approvedOvertime Overtime[]

  // Absence Relations
  approvedAbsences Absence[]

  // Volume Relations (Expedição)
  VolumesCreated   Volume[] @relation("VolumeCreatedBy")
  VolumesClosed    Volume[] @relation("VolumeClosedBy")
  VolumesDelivered Volume[] @relation("VolumeDeliveredBy")

  // Label Templates Relations
  LabelTemplatesCreated LabelTemplate[]

  @@unique([email, deletedAt], name: "users_email_unique_active")
  @@unique([username, deletedAt], name: "users_username_unique_active")
  // Optimizations
  @@index([failedLoginAttempts, blockedUntil, lastLoginIp])
  @@index([passwordResetToken, passwordResetExpires])
  @@index([forcePasswordReset])
  @@index([id, deletedAt])
  @@map("users")
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Personal Information
  name     String    @default("") @db.VarChar(64)
  surname  String    @default("") @db.VarChar(64)
  birthday DateTime? @db.Date
  location String    @default("") @db.VarChar(128)

  // Secondary Information
  bio       String @default("") @db.VarChar(256)
  avatarUrl String @default("") @map("avatar_url") @db.VarChar(512)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

model Session {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tenantId   String?   @map("tenant_id")
  ip         String    @db.VarChar(64)
  createdAt  DateTime  @default(now()) @map("created_at")
  expiredAt  DateTime? @map("expired_at")
  revokedAt  DateTime? @map("revoked_at")
  lastUsedAt DateTime? @map("last_used_at")

  // Device Information
  userAgent      String? @map("user_agent") @db.VarChar(512)
  deviceType     String? @map("device_type") @db.VarChar(32) // desktop, mobile, tablet, bot, unknown
  deviceName     String? @map("device_name") @db.VarChar(128) // iPhone 15, Samsung Galaxy S24, etc.
  browserName    String? @map("browser_name") @db.VarChar(64) // Chrome, Firefox, Safari, etc.
  browserVersion String? @map("browser_version") @db.VarChar(32)
  osName         String? @map("os_name") @db.VarChar(64) // Windows, macOS, iOS, Android, Linux
  osVersion      String? @map("os_version") @db.VarChar(32)

  // Geolocation (based on IP)
  country     String? @db.VarChar(64) // Brazil, United States, etc.
  countryCode String? @map("country_code") @db.VarChar(2) // BR, US, etc.
  region      String? @db.VarChar(64) // São Paulo, California, etc.
  city        String? @db.VarChar(64)
  timezone    String? @db.VarChar(64) // America/Sao_Paulo, etc.
  latitude    Float?
  longitude   Float?

  // Security & Trust
  isTrusted       Boolean   @default(false) @map("is_trusted") // User marked as trusted device
  trustVerifiedAt DateTime? @map("trust_verified_at") // When device was verified
  loginMethod     String?   @map("login_method") @db.VarChar(32) // password, oauth, magic_link, api_key

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant?        @relation(fields: [tenantId], references: [id])
  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([tenantId])
  @@index([ip])
  @@index([deviceType])
  @@index([country])
  @@index([isTrusted])
  @@map("sessions")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  sessionId String    @map("session_id")
  tenantId  String?   @map("tenant_id")
  token     String    @unique @db.VarChar(2048)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenant  Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([tenantId])
  @@index([token])
  @@map("refresh_tokens")
}

// ===============================================
// RBAC MODULE
// ===============================================

/// Representa uma permissão específica no sistema
model Permission {
  id String @id @default(uuid())

  // Identificador único da permissão (ex: core.users.create)
  code String @unique @db.VarChar(128)

  // Nome legível da permissão
  name String @db.VarChar(128)

  // Descrição detalhada do que a permissão permite
  description String? @db.Text

  // Módulo ao qual a permissão pertence
  module String @db.VarChar(64) // core, stock, sales

  // Recurso ao qual a permissão se aplica
  resource String @db.VarChar(64) // users, products, orders

  // Ação permitida
  action String @db.VarChar(64) // create, read, update, delete, request, approve

  // Se é uma permissão do sistema (não pode ser deletada)
  isSystem Boolean @default(false) @map("is_system")

  // Metadados adicionais (para ABAC futuramente)
  metadata Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  permissionGroups PermissionGroupPermission[]
  directUsers      UserDirectPermission[]

  @@index([module, resource, action])
  @@index([code])
  @@index([module])
  @@map("permissions")
}

/// Grupo de permissões (equivalente a uma Role customizável)
model PermissionGroup {
  id String @id @default(uuid())

  // Nome do grupo (ex: "Gerente de Estoque", "Vendedor")
  name String @db.VarChar(128)

  // Slug para uso programático
  slug String @db.VarChar(128)

  // Descrição do grupo
  description String? @db.Text

  // Se é um grupo do sistema (não pode ser deletado)
  isSystem Boolean @default(false) @map("is_system")

  // Se o grupo está ativo
  isActive Boolean @default(true) @map("is_active")

  // Cor para UI (opcional)
  color String? @db.VarChar(7) // hex color

  // Prioridade (para resolver conflitos)
  priority Int @default(0)

  // Grupo pai (para herança)
  parentId String? @map("parent_id")

  // Tenant scope (null = grupo global/template, non-null = grupo do tenant)
  tenantId String? @map("tenant_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  parent      PermissionGroup?            @relation("GroupHierarchy", fields: [parentId], references: [id])
  children    PermissionGroup[]           @relation("GroupHierarchy")
  permissions PermissionGroupPermission[]
  users       UserPermissionGroup[]
  tenant      Tenant?                     @relation(fields: [tenantId], references: [id])

  @@unique([name, tenantId, deletedAt], name: "permission_groups_name_tenant_unique_active")
  @@unique([slug, tenantId, deletedAt], name: "permission_groups_slug_tenant_unique_active")
  @@index([slug])
  @@index([isActive])
  @@index([parentId])
  @@index([tenantId])
  @@map("permission_groups")
}

/// Relacionamento entre Grupos e Permissões
model PermissionGroupPermission {
  id String @id @default(uuid())

  groupId      String @map("group_id")
  permissionId String @map("permission_id")

  // Tipo de acesso (allow ou deny)
  // Deny tem precedência sobre allow
  effect String @default("allow") @db.VarChar(10) // allow, deny

  // Condições para aplicar a permissão (JSON com regras ABAC)
  conditions Json? @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  group      PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
  @@map("permission_group_permissions")
}

/// Relacionamento entre Usuários e Grupos de Permissões
model UserPermissionGroup {
  id String @id @default(uuid())

  userId  String @map("user_id")
  groupId String @map("group_id")

  // Data de expiração (opcional, para acesso temporário)
  expiresAt DateTime? @map("expires_at")

  // Quem concedeu o acesso
  grantedBy String? @map("granted_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  group   PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  granter User?           @relation("GrantedPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@index([expiresAt])
  @@map("user_permission_groups")
}

/// Permissões atribuídas diretamente a usuários (sem passar por grupos)
model UserDirectPermission {
  id String @id @default(uuid())

  userId       String @map("user_id")
  permissionId String @map("permission_id")

  // Tipo de acesso (allow ou deny)
  // Deny tem precedência sobre allow
  effect String @default("allow") @db.VarChar(10) // allow, deny

  // Condições para aplicar a permissão (JSON com regras ABAC)
  conditions Json? @default("{}")

  // Data de expiração (opcional, para acesso temporário)
  expiresAt DateTime? @map("expires_at")

  // Quem concedeu a permissão
  grantedBy String? @map("granted_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user       User       @relation("UserDirectPermissions", fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granter    User?      @relation("GrantedDirectPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt])
  @@index([effect])
  @@map("user_direct_permissions")
}

/// Log de verificações de permissão (auditoria)
model PermissionAuditLog {
  id String @id @default(uuid())

  userId         String @map("user_id")
  permissionCode String @map("permission_code") @db.VarChar(128)

  // Resultado da verificação
  allowed Boolean

  // Motivo (qual regra permitiu/negou)
  reason String? @db.VarChar(512)

  // Contexto da requisição
  resource   String? @db.VarChar(64)
  resourceId String? @map("resource_id")
  action     String? @db.VarChar(64)

  // Metadados da requisição
  ip        String? @db.VarChar(64)
  userAgent String? @map("user_agent") @db.VarChar(512)
  endpoint  String? @db.VarChar(256)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([permissionCode])
  @@index([allowed])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("permission_audit_logs")
}

// ===============================================
// INVENTORY MANAGEMENT MODULE
// ===============================================

// --- Enums ---

enum UnitOfMeasure {
  METERS
  KILOGRAMS
  UNITS
}

enum MovementType {
  SALE
  PRODUCTION
  SAMPLE
  LOSS
  TRANSFER
  INVENTORY_ADJUSTMENT
  ZONE_RECONFIGURE
}

enum AuditAction {
  // CRUD básico
  CREATE
  UPDATE
  DELETE
  RESTORE
  DUPLICATE

  // Autenticação e Sessão
  LOGIN
  LOGOUT
  SESSION_REFRESH
  SESSION_EXPIRE
  SESSION_REVOKE

  // Senha e Segurança
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  PASSWORD_FORCE_RESET

  // Perfil de Usuário
  EMAIL_CHANGE
  USERNAME_CHANGE
  PROFILE_CHANGE
  ROLE_CHANGE

  // RBAC - Permissões
  PERMISSION_GRANT
  PERMISSION_REVOKE
  PERMISSION_UPDATE
  GROUP_ASSIGN
  GROUP_REMOVE
  PERMISSION_ADD_TO_GROUP
  PERMISSION_REMOVE_FROM_GROUP

  // Estoque
  PRICE_CHANGE
  STOCK_ENTRY
  STOCK_EXIT
  STOCK_TRANSFER
  STOCK_ADJUSTMENT

  // Pedidos e Compras
  ORDER_CREATE
  ORDER_CANCEL
  STATUS_CHANGE

  // Reservas
  RESERVATION_CREATE
  RESERVATION_RELEASE

  // HR - Funcionários
  EMPLOYEE_HIRE
  EMPLOYEE_TERMINATE
  EMPLOYEE_TRANSFER
  EMPLOYEE_LINK_USER

  // HR - Ponto e Tempo
  CLOCK_IN
  CLOCK_OUT
  TIME_CALCULATE
  TIME_BANK_CREDIT
  TIME_BANK_DEBIT
  TIME_BANK_ADJUST

  // HR - Ausências e Férias
  ABSENCE_REQUEST
  ABSENCE_APPROVE
  ABSENCE_REJECT
  ABSENCE_CANCEL
  VACATION_SCHEDULE
  VACATION_START
  VACATION_COMPLETE
  VACATION_CANCEL
  VACATION_SELL

  // HR - Horas Extras
  OVERTIME_REQUEST
  OVERTIME_APPROVE

  // Payroll - Folha de Pagamento
  PAYROLL_CREATE
  PAYROLL_CALCULATE
  PAYROLL_APPROVE
  PAYROLL_CANCEL
  PAYROLL_PAY

  // Requests - Workflow
  REQUEST_CREATE
  REQUEST_ASSIGN
  REQUEST_COMPLETE
  REQUEST_CANCEL
  REQUEST_COMMENT
  REQUEST_INFO
  REQUEST_INFO_PROVIDE

  // Notificações
  NOTIFICATION_SEND
  NOTIFICATION_READ
  NOTIFICATION_DELETE

  // Verificações
  CHECK_CPF
  CHECK_CNPJ

  // Sistema
  EXPORT
  IMPORT
  SYNC
  OTHER
}

enum AuditEntity {
  // Auth & Users
  USER
  USER_PROFILE
  USER_EMAIL
  USER_PASSWORD
  USER_USERNAME
  USER_ROLE
  SESSION
  REFRESH_TOKEN

  // RBAC - Controle de Acesso
  PERMISSION
  PERMISSION_GROUP
  PERMISSION_GROUP_PERMISSION
  USER_PERMISSION_GROUP
  USER_DIRECT_PERMISSION

  // Core
  LABEL_TEMPLATE

  // Stock Management - Estoque
  PRODUCT
  VARIANT
  ITEM
  CATEGORY
  SUPPLIER
  MANUFACTURER
  LOCATION
  TEMPLATE
  ITEM_MOVEMENT
  PRODUCT_CATEGORY
  VARIANT_PRICE_HISTORY
  TAG
  PRODUCT_TAG
  VARIANT_IMAGE
  PURCHASE_ORDER
  PURCHASE_ORDER_ITEM
  UNIT_CONVERSION
  STOCK_SNAPSHOT
  VARIANT_SUPPLIER_CODE
  VARIANT_PROMOTION

  // Sales - Vendas
  CUSTOMER
  SALES_ORDER
  SALES_ORDER_ITEM
  ITEM_RESERVATION

  // Alerts & Notifications
  ALERT
  NOTIFICATION
  NOTIFICATION_TEMPLATE
  NOTIFICATION_PREFERENCE

  // Comments - Comentários
  COMMENT

  // Requests - Workflow de Solicitações
  REQUEST
  REQUEST_ATTACHMENT
  REQUEST_COMMENT
  REQUEST_HISTORY

  // HR - Organization (Empresa/Company)
  COMPANY
  COMPANY_ADDRESS
  COMPANY_CNAE
  COMPANY_FISCAL_SETTINGS
  COMPANY_STAKEHOLDER

  // HR - Estrutura Organizacional
  EMPLOYEE
  DEPARTMENT
  POSITION

  // HR - Controle de Ponto e Tempo
  TIME_ENTRY
  WORK_SCHEDULE
  OVERTIME
  TIME_BANK

  // HR - Ausências e Férias
  ABSENCE
  VACATION_PERIOD
  VACATION_BALANCE

  // Payroll - Folha de Pagamento
  PAYROLL
  PAYROLL_ITEM
  BONUS
  DEDUCTION

  // Finance - Financeiro
  COST_CENTER
  BANK_ACCOUNT
  FINANCE_CATEGORY
  FINANCE_ENTRY
  FINANCE_ENTRY_PAYMENT
  FINANCE_ATTACHMENT
  LOAN
  LOAN_INSTALLMENT
  CONSORTIUM
  CONSORTIUM_PAYMENT

  // System
  OTHER
}

enum AuditModule {
  CORE
  AUTH
  RBAC
  STOCK
  SALES
  HR
  PAYROLL
  REQUESTS
  NOTIFICATIONS
  FINANCE
  SYSTEM
  OTHER
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  DISCONTINUED
  OUT_OF_STOCK
}

enum ItemStatus {
  AVAILABLE
  RESERVED
  IN_TRANSIT
  DAMAGED
  EXPIRED
  DISPOSED
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  EXPIRING_SOON
  EXPIRED
  PRICE_CHANGE
  REORDER_POINT
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
}

// --- Location System v2 Enums ---

enum LocationType {
  WAREHOUSE
  ZONE
  AISLE
  RACK
  SHELF
  BIN
  FLOOR
  ROOM
  OTHER
}

enum BinLabeling {
  LETTERS
  NUMBERS
}

enum BinDirection {
  BOTTOM_UP
  TOP_DOWN
}

enum LayoutAnnotationType {
  DOOR
  PILLAR
  WALL
  LABEL
  AREA
}

enum CustomerType {
  INDIVIDUAL
  BUSINESS
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

// --- Workflow Notifications Enums ---

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// --- Entidades ---

// Organization - Base unificada para Company, Supplier, Manufacturer
model Organization {
  id   String           @id @default(uuid())
  type OrganizationType // COMPANY | SUPPLIER | MANUFACTURER | CUSTOMER

  // Dados obrigatórios
  legalName String @map("legal_name") @db.VarChar(256)

  // Identificação fiscal
  cnpj String? @db.VarChar(18) // Para PJ
  cpf  String? @db.VarChar(14) // Para PF (alguns fornecedores)

  // Dados opcionais principais
  tradeName             String?                @map("trade_name") @db.VarChar(256)
  stateRegistration     String?                @map("state_registration") @db.VarChar(128)
  municipalRegistration String?                @map("municipal_registration") @db.VarChar(128)
  legalNature           String?                @map("legal_nature") @db.VarChar(256)
  taxRegime             TaxRegimeEnum?         @map("tax_regime")
  taxRegimeDetail       String?                @map("tax_regime_detail") @db.VarChar(256)
  activityStartDate     DateTime?              @map("activity_start_date")
  status                OrganizationStatusEnum @default(ACTIVE)
  email                 String?                @db.VarChar(256)
  phoneMain             String?                @map("phone_main") @db.VarChar(20)
  phoneAlt              String?                @map("phone_alt") @db.VarChar(20)
  website               String?                @db.VarChar(512)
  logoUrl               String?                @map("logo_url") @db.VarChar(512)

  // Dados específicos por tipo (JSON para campos que variam por tipo)
  // Supplier: { paymentTerms, rating, sequentialCode, etc }
  // Manufacturer: { rating, country, etc }
  // Company: { pendingIssues, internalCode, etc }
  typeSpecificData Json? @default("{}") @map("type_specific_data")

  // Metadados
  metadata Json    @default("{}")
  notes    String? @db.Text

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos polimórficos
  addresses      OrganizationAddress[]
  cnaes          OrganizationCnae[]
  fiscalSettings OrganizationFiscalSettings?
  stakeholders   OrganizationStakeholder[]
  employees      Employee[]
  products       Product[]

  @@unique([cnpj, type, deletedAt], name: "organizations_cnpj_type_unique_active")
  @@unique([cpf, type, deletedAt], name: "organizations_cpf_type_unique_active")
  @@index([type])
  @@index([cnpj])
  @@index([cpf])
  @@index([legalName])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationAddress {
  id String @id @default(uuid())

  organizationId String             @map("organization_id")
  type           CompanyAddressType @default(OTHER)
  street         String?            @db.VarChar(256)
  number         String?            @db.VarChar(32)
  complement     String?            @db.VarChar(128)
  district       String?            @db.VarChar(128)
  city           String?            @db.VarChar(128)
  state          String?            @db.VarChar(2)
  zip            String             @db.VarChar(10)
  ibgeCityCode   String?            @map("ibge_city_code") @db.VarChar(16)
  countryCode    String?            @default("BR") @map("country_code") @db.VarChar(4)
  isPrimary      Boolean            @default(false) @map("is_primary")

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, type, deletedAt], name: "organization_addresses_org_type_unique_active")
  @@index([organizationId])
  @@index([type])
  @@index([zip])
  @@index([isPrimary])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organization_addresses")
}

model OrganizationCnae {
  id String @id @default(uuid())

  organizationId String            @map("organization_id")
  code           String            @db.VarChar(16)
  description    String?           @db.VarChar(256)
  isPrimary      Boolean           @default(false) @map("is_primary")
  status         CompanyCnaeStatus @default(ACTIVE)

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, code, deletedAt], name: "organization_cnaes_org_code_unique_active")
  @@index([organizationId])
  @@index([code])
  @@index([isPrimary])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organization_cnaes")
}

model OrganizationFiscalSettings {
  id String @id @default(uuid())

  organizationId String @unique @map("organization_id")

  // NFe - Nota Fiscal Eletrônica
  nfeEnabled     Boolean?                @default(false) @map("nfe_enabled")
  nfeSeries      Int?                    @map("nfe_series")
  nfeNumber      Int?                    @default(1) @map("nfe_number")
  nfeEnvironment NfeEnvironment?         @map("nfe_environment")
  nfePassword    String?                 @map("nfe_password") @db.VarChar(128)
  nfeCertificate String?                 @map("nfe_certificate") @db.Text
  nfeCertType    DigitalCertificateType? @map("nfe_cert_type")

  // Impostos - Alíquotas padrão
  defaultIcmsRate   Decimal? @default(0) @map("default_icms_rate") @db.Decimal(5, 2)
  defaultIpiRate    Decimal? @default(0) @map("default_ipi_rate") @db.Decimal(5, 2)
  defaultPisRate    Decimal? @default(0) @map("default_pis_rate") @db.Decimal(5, 2)
  defaultCofinsRate Decimal? @default(0) @map("default_cofins_rate") @db.Decimal(5, 2)

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organization_fiscal_settings")
}

model OrganizationStakeholder {
  id String @id @default(uuid())

  organizationId String                    @map("organization_id")
  name           String                    @db.VarChar(256)
  cpf            String?                   @db.VarChar(14)
  role           CompanyStakeholderRole?
  qualification  String?                   @db.VarChar(256)
  entryDate      DateTime?                 @map("entry_date")
  exitDate       DateTime?                 @map("exit_date")
  status         CompanyStakeholderStatus  @default(ACTIVE)
  source         CompanyStakeholderSource? @default(MANUAL)

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, cpf, deletedAt], name: "organization_stakeholders_org_cpf_unique_active")
  @@index([organizationId])
  @@index([cpf])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organization_stakeholders")
}

model Supplier {
  id             String  @id @default(uuid())
  sequentialCode Int     @default(autoincrement()) @map("sequential_code")
  name           String  @db.VarChar(128)
  cnpj           String? @db.VarChar(18)
  taxId          String? @map("tax_id") @db.VarChar(32) // Inscrição Estadual
  contact        String? @db.VarChar(128)

  // Contato
  email   String? @db.VarChar(254)
  phone   String? @db.VarChar(20)
  website String? @db.VarChar(512)

  // Endereço
  address String? @db.VarChar(256)
  city    String? @db.VarChar(128)
  state   String? @db.VarChar(2) // UF
  zipCode String? @map("zip_code") @db.VarChar(10)
  country String? @db.VarChar(64)

  // Gestão Comercial
  paymentTerms String?  @map("payment_terms") @db.VarChar(256)
  rating       Decimal? @db.Decimal(3, 2) // 0.00 a 5.00
  isActive     Boolean  @default(true) @map("is_active")
  notes        String?  @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  products             Product[]
  purchaseOrders       PurchaseOrder[]
  variantSupplierCodes VariantSupplierCode[]

  @@unique([cnpj, tenantId, deletedAt], name: "suppliers_cnpj_unique_active")
  @@index([sequentialCode])
  @@index([isActive])
  @@index([rating])
  @@index([tenantId])
  @@map("suppliers")
}

model Manufacturer {
  id             String  @id @default(uuid())
  code           String  @db.VarChar(3) // Código hierárquico auto-gerado (ex: 001)
  sequentialCode Int     @default(autoincrement()) @map("sequential_code") // Para geração do code
  name           String  @db.VarChar(128)
  legalName      String? @map("legal_name") @db.VarChar(256)
  cnpj           String? @db.VarChar(18)
  country        String? @db.VarChar(64)

  // Contato
  email   String? @db.VarChar(254)
  phone   String? @db.VarChar(20)
  website String? @db.VarChar(512)

  // Endereço
  address String? @db.VarChar(256)
  city    String? @db.VarChar(128)
  state   String? @db.VarChar(64)
  zipCode String? @map("zip_code") @db.VarChar(10)

  // Gestão
  isActive Boolean  @default(true) @map("is_active")
  notes    String?  @db.Text
  rating   Decimal? @db.Decimal(3, 2) // 0.00 a 5.00

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  products Product[]

  @@unique([code, tenantId], name: "manufacturers_code_tenant_unique")
  @@index([isActive])
  @@index([rating])
  @@index([sequentialCode])
  @@index([tenantId])
  @@map("manufacturers")
}

model Category {
  id           String    @id @default(uuid())
  name         String    @db.VarChar(128)
  slug         String    @db.VarChar(128)
  description  String?   @db.VarChar(500)
  iconUrl      String?   @map("icon_url") @db.VarChar(512) // URL do ícone SVG da categoria
  parentId     String?   @map("parent_id")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  parent            Category?         @relation("SubCategories", fields: [parentId], references: [id])
  subCategories     Category[]        @relation("SubCategories")
  productCategories ProductCategory[]

  @@unique([slug, tenantId, deletedAt], name: "categories_slug_unique_active")
  @@index([parentId, deletedAt])
  @@index([tenantId])
  @@map("categories")
}

// ============================================
// LOCATION SYSTEM V2 - Warehouse/Zone/Bin
// ============================================

model Warehouse {
  id          String  @id @default(uuid())
  code        String  @db.VarChar(5) // Ex: "FAB", "CD1"
  name        String  @db.VarChar(128)
  description String? @db.VarChar(500)
  address     String? @db.VarChar(256)

  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  zones Zone[]

  @@unique([code, tenantId, deletedAt], name: "warehouses_code_unique_active")
  @@index([isActive])
  @@index([tenantId])
  @@map("warehouses")
}

model Zone {
  id          String  @id @default(uuid())
  warehouseId String  @map("warehouse_id")
  code        String  @db.VarChar(5) // Ex: "EST", "PRD", "EXP"
  name        String  @db.VarChar(128)
  description String? @db.VarChar(500)

  // Configuração da estrutura física (JSONB)
  structure Json @default("{}") // ZoneStructure

  // Layout visual customizado (JSONB, opcional)
  layout Json? // ZoneLayout

  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  bins      Bin[]

  @@unique([warehouseId, code, deletedAt], name: "zones_warehouse_code_unique_active")
  @@index([warehouseId])
  @@index([isActive])
  @@index([tenantId])
  @@map("zones")
}

model Bin {
  id     String @id @default(uuid())
  zoneId String @map("zone_id")

  // Endereço completo - índice único (Ex: "FAB-EST-102-B")
  address String @db.VarChar(32)

  // Posição (derivada, mas indexada para queries rápidas)
  aisle    Int // Corredor (1-99)
  shelf    Int // Prateleira (1-999)
  position String @db.VarChar(3) // Nicho ("A", "B", "C" ou "1", "2", "3")

  // Capacidade e ocupação
  capacity         Int? // Capacidade máxima (opcional)
  currentOccupancy Int  @default(0) @map("current_occupancy")

  // Status
  isActive    Boolean @default(true) @map("is_active")
  isBlocked   Boolean @default(false) @map("is_blocked")
  blockReason String? @map("block_reason") @db.VarChar(256)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  zone           Zone            @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  items          Item[]
  stockSnapshots StockSnapshot[]

  @@unique([address, tenantId, deletedAt], name: "bins_address_unique_active")
  @@unique([zoneId, aisle, shelf, position, deletedAt], name: "bins_position_unique_active")
  @@index([zoneId])
  @@index([address])
  @@index([aisle])
  @@index([isActive])
  @@index([isBlocked])
  @@index([zoneId, aisle, shelf])
  @@index([tenantId])
  @@map("bins")
}

// ===============================================
// VOLUMES / ROMANEIO (EXPEDIÇÃO)
// ===============================================

enum VolumeStatus {
  OPEN
  CLOSED
  DELIVERED
  RETURNED
}

model Volume {
  id             String       @id @default(uuid())
  code           String
  name           String?      @db.VarChar(256)
  status         VolumeStatus @default(OPEN)
  notes          String?      @db.Text
  destinationRef String?      @db.VarChar(256)

  // Relacionamentos
  salesOrderId String? @map("sales_order_id")
  customerId   String? @map("customer_id")

  items VolumeItem[]

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  closedAt    DateTime? @map("closed_at")
  deliveredAt DateTime? @map("delivered_at")
  returnedAt  DateTime? @map("returned_at")
  deletedAt   DateTime? @map("deleted_at")

  // Audit
  createdBy   String  @map("created_by")
  closedBy    String? @map("closed_by")
  deliveredBy String? @map("delivered_by")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdByUser   User  @relation("VolumeCreatedBy", fields: [createdBy], references: [id])
  closedByUser    User? @relation("VolumeClosedBy", fields: [closedBy], references: [id])
  deliveredByUser User? @relation("VolumeDeliveredBy", fields: [deliveredBy], references: [id])

  @@unique([code, tenantId], name: "volumes_code_tenant_unique")
  @@index([status])
  @@index([code])
  @@index([createdAt])
  @@index([closedAt])
  @@index([deletedAt])
  @@index([tenantId])
  @@map("volumes")
}

model VolumeItem {
  id       String @id @default(uuid())
  volumeId String @map("volume_id")
  volume   Volume @relation(fields: [volumeId], references: [id], onDelete: Cascade)
  itemId   String @map("item_id")
  item     Item   @relation("VolumeItems", fields: [itemId], references: [id])

  addedAt DateTime @default(now()) @map("added_at")
  addedBy String   @map("added_by")

  @@unique([volumeId, itemId], name: "volume_items_unique")
  @@index([volumeId])
  @@index([itemId])
  @@map("volume_items")
}

// --- Hierarquia Principal de Estoque ---

model Template {
  id                String        @id @default(uuid())
  code              String?       @unique @db.VarChar(3) // Código hierárquico manual ou auto-gerado (ex: 001)
  sequentialCode    Int           @default(autoincrement()) @map("sequential_code") // Para fallback na geração do code
  name              String        @db.VarChar(128)
  iconUrl           String?       @map("icon_url") @db.VarChar(512) // URL do ícone SVG do template
  unitOfMeasure     UnitOfMeasure @default(UNITS) @map("unit_of_measure")
  productAttributes Json          @default("{}") @map("product_attributes") // TemplateAttribute[] - atributos tipados com unitOfMeasure, enablePrint, enableView
  variantAttributes Json          @default("{}") @map("variant_attributes") // TemplateAttribute[] - atributos tipados com unitOfMeasure, enablePrint, enableView
  itemAttributes    Json          @default("{}") @map("item_attributes") // TemplateAttribute[] - atributos tipados com unitOfMeasure, enablePrint, enableView
  careLabel         Json?         @map("care_label") // Etiqueta de conservação: { washing, drying, ironing, bleaching, dryClean, composition }
  isActive          Boolean       @default(true) @map("is_active")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  products Product[]

  @@unique([name, tenantId, deletedAt], name: "templates_name_unique_active")
  @@index([sequentialCode])
  @@index([isActive])
  @@index([code])
  @@index([tenantId])
  @@map("templates")
}

model Product {
  id             String        @id @default(uuid())
  name           String        @db.VarChar(256)
  slug           String        @db.VarChar(300) // Slug gerado automaticamente do nome - IMUTÁVEL
  fullCode       String        @unique @map("full_code") @db.VarChar(20) // Código hierárquico: TEMPLATE.FABRICANTE.PRODUTO (ex: 001.001.0001) - IMUTÁVEL
  sequentialCode Int           @default(autoincrement()) @map("sequential_code")
  description    String?       @db.Text
  status         ProductStatus @default(ACTIVE)
  outOfLine      Boolean       @default(false) @map("out_of_line")
  attributes     Json          @default("{}")

  // Códigos de Barras (gerados automaticamente do fullCode) - IMUTÁVEIS
  barcode String  @unique @db.VarChar(30) // Code128 baseado no fullCode
  eanCode String  @unique @map("ean_code") @db.VarChar(13) // EAN-13 gerado do fullCode
  upcCode String  @unique @map("upc_code") @db.VarChar(12) // UPC gerado do fullCode
  qrCode  String? @map("qr_code") @db.VarChar(512) // QR Code editável

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Care Instructions (ISO 3758 codes)
  careInstructionIds String[] @default([]) @map("care_instruction_ids")

  templateId     String  @map("template_id")
  supplierId     String? @map("supplier_id") // DEPRECATED: Migrar para organizationId
  manufacturerId String? @map("manufacturer_id") // Código do fabricante no fullCode (000 se não houver)
  organizationId String? @map("organization_id") // Nova relação unificada

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  template          Template          @relation(fields: [templateId], references: [id])
  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  manufacturer      Manufacturer?     @relation(fields: [manufacturerId], references: [id])
  organization      Organization?     @relation(fields: [organizationId], references: [id])
  variants          Variant[]
  productCategories ProductCategory[]
  productTags       ProductTag[]

  @@unique([slug, tenantId, deletedAt], name: "products_slug_unique_active")
  @@index([templateId])
  @@index([supplierId])
  @@index([manufacturerId])
  @@index([organizationId])
  @@index([status])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([barcode])
  @@index([eanCode])
  @@index([upcCode])
  @@index([slug, deletedAt])
  @@index([name, deletedAt])
  @@index([tenantId])
  @@map("products")
}

model Variant {
  id             String  @id @default(uuid())
  sku            String? @db.VarChar(64) // SKU manual ou gerado do nome
  slug           String  @db.VarChar(300) // Slug gerado automaticamente do nome - IMUTÁVEL
  fullCode       String  @unique @map("full_code") @db.VarChar(24) // Código hierárquico: TEMPLATE.FABRICANTE.PRODUTO.VARIANTE (ex: 001.001.0001.001) - IMUTÁVEL
  sequentialCode Int     @map("sequential_code") // Sequencial LOCAL ao produto (NÃO autoincrement)
  name           String  @db.VarChar(256)
  price          Decimal @default(0) @db.Decimal(10, 2)
  imageUrl       String? @map("image_url") @db.VarChar(512)
  attributes     Json    @default("{}")
  isActive       Boolean @default(true) @map("is_active")

  // Preço e Margem
  costPrice    Decimal? @map("cost_price") @db.Decimal(10, 2)
  profitMargin Decimal? @map("profit_margin") @db.Decimal(5, 2) // Percentual

  // Códigos de Barras (gerados automaticamente do fullCode) - IMUTÁVEIS
  barcode String  @unique @db.VarChar(30) // Code128 baseado no fullCode
  eanCode String  @unique @map("ean_code") @db.VarChar(13) // EAN-13 gerado do fullCode
  upcCode String  @unique @map("upc_code") @db.VarChar(12) // UPC gerado do fullCode
  qrCode  String? @map("qr_code") @db.VarChar(512) // QR Code editável

  // Cores
  colorHex     String? @map("color_hex") @db.VarChar(7) // Formato hex: #FF5733
  colorPantone String? @map("color_pantone") @db.VarChar(32) // Ex: "PMS 185 C"

  // Controle de Estoque
  minStock        Decimal? @map("min_stock") @db.Decimal(10, 3)
  maxStock        Decimal? @map("max_stock") @db.Decimal(10, 3)
  reorderPoint    Decimal? @map("reorder_point") @db.Decimal(10, 3)
  reorderQuantity Decimal? @map("reorder_quantity") @db.Decimal(10, 3)

  // Referência e Semelhantes
  reference String? @db.VarChar(128) // Referência do fornecedor/fabricante
  similars  Json?   @default("[]") // IDs de variantes semelhantes
  outOfLine Boolean @default(false) @map("out_of_line") // Fora de linha/descontinuado

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  productId String  @map("product_id")
  tenantId  String  @map("tenant_id")
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  items              Item[]
  priceHistory       VariantPriceHistory[]
  variantImages      VariantImage[]
  unitConversions    UnitConversion[]
  stockSnapshots     StockSnapshot[]
  purchaseOrderItems PurchaseOrderItem[]
  salesOrderItems    SalesOrderItem[]
  variantPromotions  VariantPromotion[]
  supplierCodes      VariantSupplierCode[]

  @@unique([sku, tenantId, deletedAt], name: "variants_sku_unique_active")
  @@unique([slug, tenantId, deletedAt], name: "variants_slug_unique_active")
  @@index([productId])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([isActive])
  @@index([barcode])
  @@index([eanCode])
  @@index([upcCode])
  @@index([slug, deletedAt])
  @@index([tenantId])
  @@map("variants")
}

model Item {
  id              String     @id @default(uuid())
  uniqueCode      String?    @map("unique_code") @db.VarChar(128) // Código único manual ou UUID
  slug            String     @db.VarChar(300) // Slug gerado automaticamente - IMUTÁVEL
  fullCode        String     @unique @map("full_code") @db.VarChar(30) // Código hierárquico: TEMPLATE.FABRICANTE.PRODUTO.VARIANTE-ITEM (ex: 001.001.0001.001-00001) - IMUTÁVEL
  sequentialCode  Int        @map("sequential_code") // Sequencial LOCAL à variante (NÃO autoincrement)
  initialQuantity Decimal    @map("initial_quantity") @db.Decimal(10, 3)
  currentQuantity Decimal    @map("current_quantity") @db.Decimal(10, 3)
  unitCost        Decimal?   @map("unit_cost") @db.Decimal(10, 2) // Custo unitário de aquisição
  status          ItemStatus @default(AVAILABLE)
  entryDate       DateTime   @default(now()) @map("entry_date")
  attributes      Json       @default("{}")

  // Códigos de Barras (gerados automaticamente do fullCode) - IMUTÁVEIS
  barcode String  @unique @db.VarChar(30) // Code128 baseado no fullCode
  eanCode String  @unique @map("ean_code") @db.VarChar(13) // EAN-13 gerado do fullCode
  upcCode String  @unique @map("upc_code") @db.VarChar(12) // UPC gerado do fullCode
  qrCode  String? @map("qr_code") @db.VarChar(512) // QR Code editável

  // Lote e Validade
  batchNumber       String?   @map("batch_number") @db.VarChar(64)
  manufacturingDate DateTime? @map("manufacturing_date") @db.Date
  expiryDate        DateTime? @map("expiry_date") @db.Date

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  variantId        String  @map("variant_id")
  binId            String? @map("bin_id") // Referência ao Bin (localização específica)
  lastKnownAddress String? @map("last_known_address") @db.VarChar(64) // Último endereço conhecido (preservado quando bin é removido)
  tenantId         String  @map("tenant_id")
  tenant           Tenant  @relation(fields: [tenantId], references: [id])

  variant      Variant           @relation(fields: [variantId], references: [id])
  bin          Bin?              @relation(fields: [binId], references: [id])
  movements    ItemMovement[]
  reservations ItemReservation[]
  volumeItems  VolumeItem[]      @relation("VolumeItems")

  @@unique([uniqueCode, tenantId, deletedAt], name: "items_uniqueCode_unique_active")
  @@unique([slug, tenantId, deletedAt], name: "items_slug_unique_active")
  @@index([variantId])
  @@index([binId])
  @@index([sequentialCode])
  @@index([fullCode])
  @@index([batchNumber])
  @@index([expiryDate])
  @@index([status])
  @@index([barcode])
  @@index([eanCode])
  @@index([upcCode])
  @@index([slug, deletedAt])
  @@index([variantId, binId])
  @@index([expiryDate, deletedAt])
  @@index([batchNumber, variantId])
  @@index([tenantId])
  @@map("items")
}

model ItemMovement {
  id             String       @id @default(uuid())
  quantity       Decimal      @db.Decimal(10, 3)
  quantityBefore Decimal?     @map("quantity_before") @db.Decimal(10, 3)
  quantityAfter  Decimal?     @map("quantity_after") @db.Decimal(10, 3)
  movementType   MovementType @map("movement_type")
  reasonCode     String?      @map("reason_code") @db.VarChar(64)
  destinationRef String?      @map("destination_ref") @db.VarChar(128) // Ex: Pedido de Venda #123, OP #456
  originRef      String?      @map("origin_ref") @db.VarChar(128) // Origem da movimentação (ex: Bin: FAB-EST-102-B)
  batchNumber    String?      @map("batch_number") @db.VarChar(64)
  notes          String?      @db.Text
  createdAt      DateTime     @default(now()) @map("created_at")

  itemId       String  @map("item_id")
  userId       String  @map("user_id")
  approvedBy   String? @map("approved_by")
  salesOrderId String? @map("sales_order_id")
  tenantId     String  @map("tenant_id")
  tenant       Tenant  @relation(fields: [tenantId], references: [id])

  item       Item        @relation(fields: [itemId], references: [id])
  user       User        @relation(fields: [userId], references: [id])
  approver   User?       @relation("ApprovedMovements", fields: [approvedBy], references: [id])
  salesOrder SalesOrder? @relation(fields: [salesOrderId], references: [id])

  @@index([itemId])
  @@index([userId])
  @@index([approvedBy])
  @@index([movementType])
  @@index([batchNumber])
  @@index([salesOrderId])
  @@index([itemId, createdAt])
  @@index([userId, movementType])
  @@index([createdAt(sort: Desc)])
  @@index([tenantId])
  @@map("item_movements")
}

// --- Tabelas de Relacionamento e Histórico ---

model ProductCategory {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  categoryId String   @map("category_id")
  order      Int      @default(0) // Ordem de exibição
  featured   Boolean  @default(false) // Categoria em destaque para este produto
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([featured])
  @@map("product_categories")
}

model VariantPriceHistory {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  oldPrice  Decimal? @map("old_price") @db.Decimal(10, 2)
  newPrice  Decimal  @map("new_price") @db.Decimal(10, 2)
  reason    String?  @db.VarChar(256)
  createdAt DateTime @default(now()) @map("created_at")

  userId String @map("user_id")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([variantId])
  @@index([userId])
  @@index([createdAt])
  @@map("variant_price_history")
}

model AuditLog {
  id String @id @default(uuid())

  // Multi-Tenant (nullable for system actions)
  tenantId String? @map("tenant_id")

  action      AuditAction
  entity      AuditEntity
  module      AuditModule // Módulo da entidade
  entityId    String      @map("entity_id") // ID da entidade afetada
  description String?     @db.VarChar(512)
  oldData     Json?       @map("old_data") // Estado anterior (JSON)
  newData     Json?       @map("new_data") // Novo estado (JSON)

  // Request metadata
  ip        String? @db.VarChar(64)
  userAgent String? @map("user_agent") @db.VarChar(512)
  endpoint  String? @db.VarChar(256) // API endpoint chamado
  method    String? @db.VarChar(10) // HTTP method (GET, POST, etc)

  // User info
  userId       String? @map("user_id") // Nullable para ações do sistema
  affectedUser String? @map("affected_user") // Usuário afetado pela ação (quando diferente do executor)

  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at") // Para limpeza automática

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([affectedUser])
  @@index([action])
  @@index([entity])
  @@index([module])
  @@index([entityId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([entity, entityId])
  @@index([module, createdAt])
  @@index([userId, action])
  @@map("audit_logs")
}

// --- Sistema de Tags ---

model Tag {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(64)
  slug        String    @db.VarChar(64)
  color       String?   @db.VarChar(7) // Formato hex: #FF5733
  description String?   @db.VarChar(256)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  productTags ProductTag[]

  @@unique([name, tenantId], name: "tags_name_tenant_unique")
  @@unique([slug, tenantId], name: "tags_slug_tenant_unique")
  @@index([slug])
  @@index([tenantId])
  @@map("tags")
}

model ProductTag {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

// --- Sistema de Imagens ---

model VariantImage {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  url       String   @db.VarChar(512)
  alt       String?  @db.VarChar(256)
  order     Int      @default(0)
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([isPrimary])
  @@index([variantId, order])
  @@map("variant_images")
}

// --- Sistema de Alertas ---

model Alert {
  id        String        @id @default(uuid())
  type      AlertType
  severity  AlertSeverity @default(MEDIUM)
  entityId  String        @map("entity_id") // ID do item/variant afetado
  message   String        @db.VarChar(512)
  isRead    Boolean       @default(false) @map("is_read")
  createdAt DateTime      @default(now()) @map("created_at")
  readAt    DateTime?     @map("read_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([entityId])
  @@index([severity])
  @@index([userId, isRead])
  @@index([userId, severity, isRead])
  @@map("alerts")
}

// --- Sistema de Pedidos de Compra ---

model PurchaseOrder {
  id           String      @id @default(uuid())
  orderNumber  String      @map("order_number") @db.VarChar(64)
  status       OrderStatus @default(PENDING)
  totalCost    Decimal     @map("total_cost") @db.Decimal(10, 2)
  expectedDate DateTime?   @map("expected_date")
  receivedDate DateTime?   @map("received_date")
  notes        String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  deletedAt    DateTime?   @map("deleted_at")

  supplierId String  @map("supplier_id")
  createdBy  String? @map("created_by")
  tenantId   String  @map("tenant_id")
  tenant     Tenant  @relation(fields: [tenantId], references: [id])

  supplier Supplier @relation(fields: [supplierId], references: [id])
  creator  User?    @relation("CreatedPurchaseOrders", fields: [createdBy], references: [id])

  items PurchaseOrderItem[]

  @@unique([orderNumber, tenantId], name: "purchase_orders_order_number_tenant_unique")
  @@index([supplierId])
  @@index([status])
  @@index([orderNumber])
  @@index([expectedDate])
  @@index([createdBy])
  @@index([tenantId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  variantId String   @map("variant_id")
  quantity  Decimal  @db.Decimal(10, 3)
  unitCost  Decimal  @map("unit_cost") @db.Decimal(10, 2)
  totalCost Decimal  @map("total_cost") @db.Decimal(10, 2)
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  order   PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant       @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
  @@map("purchase_order_items")
}

// --- Sistema de Conversão de Unidades ---

model UnitConversion {
  id        String   @id @default(uuid())
  variantId String   @map("variant_id")
  fromUnit  String   @db.VarChar(32) // Ex: "CAIXA"
  toUnit    String   @db.VarChar(32) // Ex: "UNIDADE"
  factor    Decimal  @db.Decimal(10, 3) // Ex: 12 (1 caixa = 12 unidades)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, fromUnit, toUnit])
  @@index([variantId])
  @@map("unit_conversions")
}

// --- Sistema de Snapshots de Estoque ---

model StockSnapshot {
  id           String   @id @default(uuid())
  variantId    String   @map("variant_id")
  binId        String?  @map("bin_id")
  quantity     Decimal  @db.Decimal(10, 3)
  totalValue   Decimal  @map("total_value") @db.Decimal(12, 2)
  snapshotDate DateTime @map("snapshot_date")
  notes        String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  variant Variant @relation(fields: [variantId], references: [id])
  bin     Bin?    @relation(fields: [binId], references: [id])

  @@index([variantId])
  @@index([binId])
  @@index([snapshotDate])
  @@index([variantId, snapshotDate])
  @@map("stock_snapshots")
}

// --- Sistema de Clientes e Vendas ---

model Customer {
  id        String       @id @default(uuid())
  name      String       @db.VarChar(128)
  type      CustomerType @default(INDIVIDUAL)
  document  String?      @db.VarChar(18) // CPF ou CNPJ
  email     String?      @db.VarChar(254)
  phone     String?      @db.VarChar(20)
  address   String?      @db.VarChar(256)
  city      String?      @db.VarChar(128)
  state     String?      @db.VarChar(2) // UF
  zipCode   String?      @map("zip_code") @db.VarChar(10)
  country   String?      @db.VarChar(64)
  notes     String?      @db.Text
  isActive  Boolean      @default(true) @map("is_active")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  deletedAt DateTime?    @map("deleted_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  salesOrders SalesOrder[]

  @@unique([document, tenantId, deletedAt], name: "customers_document_unique_active")
  @@index([document])
  @@index([email])
  @@index([isActive])
  @@index([type])
  @@index([tenantId])
  @@map("customers")
}

model SalesOrder {
  id          String      @id @default(uuid())
  orderNumber String      @map("order_number") @db.VarChar(64)
  status      OrderStatus @default(PENDING)
  totalPrice  Decimal     @map("total_price") @db.Decimal(10, 2)
  discount    Decimal?    @default(0) @db.Decimal(10, 2)
  finalPrice  Decimal     @map("final_price") @db.Decimal(10, 2)
  notes       String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  deletedAt   DateTime?   @map("deleted_at")

  customerId String  @map("customer_id")
  createdBy  String? @map("created_by")
  tenantId   String  @map("tenant_id")
  tenant     Tenant  @relation(fields: [tenantId], references: [id])

  customer      Customer         @relation(fields: [customerId], references: [id])
  creator       User?            @relation("CreatedSalesOrders", fields: [createdBy], references: [id])
  items         SalesOrderItem[]
  itemMovements ItemMovement[]

  @@unique([orderNumber, tenantId, deletedAt], name: "sales_orders_order_number_unique_active")
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdBy])
  @@index([createdAt])
  @@index([tenantId])
  @@map("sales_orders")
}

model SalesOrderItem {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  variantId  String   @map("variant_id")
  quantity   Decimal  @db.Decimal(10, 3)
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount   Decimal? @default(0) @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant    @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
  @@map("sales_order_items")
}

// --- Sistema de Reservas ---

model ItemReservation {
  id         String    @id @default(uuid())
  itemId     String    @map("item_id")
  quantity   Decimal   @db.Decimal(10, 3)
  reason     String?   @db.VarChar(256)
  reference  String?   @db.VarChar(128) // Referência externa (pedido, etc)
  expiresAt  DateTime  @map("expires_at")
  releasedAt DateTime? @map("released_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  item   Item   @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([userId])
  @@index([expiresAt])
  @@index([itemId, expiresAt])
  @@map("item_reservations")
}

// --- Sistema de Códigos de Fornecedor ---

model VariantSupplierCode {
  id         String   @id @default(uuid())
  variantId  String   @map("variant_id")
  supplierId String   @map("supplier_id")
  code       String   @db.VarChar(64) // Código do fornecedor para este variant
  isPrimary  Boolean  @default(false) @map("is_primary")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  variant  Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@unique([variantId, supplierId])
  @@unique([supplierId, code])
  @@index([variantId])
  @@index([supplierId])
  @@index([code])
  @@map("variant_supplier_codes")
}

// --- Sistema de Promoções ---

model VariantPromotion {
  id            String       @id @default(uuid())
  variantId     String       @map("variant_id")
  name          String       @db.VarChar(128)
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  startDate     DateTime     @map("start_date")
  endDate       DateTime     @map("end_date")
  isActive      Boolean      @default(true) @map("is_active")
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  deletedAt     DateTime?    @map("deleted_at")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@index([variantId, startDate, endDate])
  @@map("variant_promotions")
}

// --- Sistema de Comentários ---

model Comment {
  id              String    @id @default(uuid())
  entityType      String    @db.VarChar(32) // "PRODUCT", "VARIANT", "ITEM", etc
  entityId        String    @db.VarChar(36) // UUID da entidade
  content         String    @db.Text
  parentCommentId String?   @map("parent_comment_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  userId  String    @map("user_id")
  user    User      @relation(fields: [userId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([entityType, entityId])
  @@index([parentCommentId])
  @@index([createdAt])
  @@map("comments")
}

// --- Sistema de Preferências de Notificação ---

model NotificationPreference {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  alertType AlertType           @map("alert_type")
  channel   NotificationChannel
  isEnabled Boolean             @default(true) @map("is_enabled")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")
  deletedAt DateTime?           @map("deleted_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, alertType, channel])
  @@index([userId])
  @@index([alertType])
  @@map("notification_preferences")
}

// --- Workflow Notifications System ---

model NotificationTemplate {
  id              String               @id @default(uuid())
  code            String               @unique @db.VarChar(64)
  name            String               @db.VarChar(128)
  titleTemplate   String               @map("title_template") @db.VarChar(256)
  messageTemplate String               @map("message_template") @db.Text
  defaultChannel  NotificationChannel  @map("default_channel")
  defaultPriority NotificationPriority @default(NORMAL) @map("default_priority")
  isActive        Boolean              @default(true) @map("is_active")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  deletedAt       DateTime?            @map("deleted_at")

  @@index([code])
  @@index([isActive])
  @@map("notification_templates")
}

model Notification {
  id           String               @id @default(uuid())
  userId       String               @map("user_id")
  title        String               @db.VarChar(256)
  message      String               @db.Text
  type         NotificationType
  priority     NotificationPriority @default(NORMAL)
  channel      NotificationChannel
  actionUrl    String?              @map("action_url") @db.VarChar(512)
  actionText   String?              @map("action_text") @db.VarChar(64)
  entityType   String?              @map("entity_type") @db.VarChar(32)
  entityId     String?              @map("entity_id") @db.VarChar(36)
  isRead       Boolean              @default(false) @map("is_read")
  isSent       Boolean              @default(false) @map("is_sent")
  scheduledFor DateTime?            @map("scheduled_for")
  readAt       DateTime?            @map("read_at")
  sentAt       DateTime?            @map("sent_at")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  deletedAt    DateTime?            @map("deleted_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([priority])
  @@index([channel])
  @@index([entityType, entityId])
  @@index([scheduledFor])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ===============================================
// REQUEST SYSTEM MODULE
// ===============================================

enum RequestType {
  ACCESS_REQUEST // Requisição de acesso
  PURCHASE_REQUEST // Requisição de compra
  APPROVAL_REQUEST // Requisição de aprovação
  ACTION_REQUEST // Requisição de ação
  CHANGE_REQUEST // Requisição de mudança
  CUSTOM // Customizado
}

enum RequestStatus {
  DRAFT // Rascunho
  SUBMITTED // Submetida
  IN_PROGRESS // Em progresso
  PENDING_INFO // Aguardando informações
  APPROVED // Aprovada
  REJECTED // Rejeitada
  CANCELLED // Cancelada
  COMPLETED // Concluída
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestTargetType {
  USER // Requisição para usuário específico
  GROUP // Requisição para grupo (ex: gestores)
}

model Request {
  id String @id @default(uuid())

  // Identificação
  title       String      @db.VarChar(200)
  description String      @db.Text
  type        RequestType
  category    String?     @db.VarChar(100) // "purchase", "access", "hr", etc

  // Status e Prioridade
  status   RequestStatus   @default(SUBMITTED)
  priority RequestPriority @default(MEDIUM)

  // Solicitante
  requesterId String @map("requester_id")
  requester   User   @relation("RequestsCreated", fields: [requesterId], references: [id])

  // Destinatário (pode ser usuário ou grupo)
  targetType RequestTargetType @map("target_type")
  targetId   String?           @map("target_id") // ID do usuário ou grupo

  // Atribuído a (responsável atual)
  assignedToId String? @map("assigned_to_id")
  assignedTo   User?   @relation("RequestsAssigned", fields: [assignedToId], references: [id])

  // SLA e Prazos
  dueDate     DateTime? @map("due_date")
  slaDeadline DateTime? @map("sla_deadline")

  // Dados flexíveis (JSON)
  metadata Json @default("{}")

  // Integração com Aprovação
  requiresApproval Boolean @default(false) @map("requires_approval")
  approvalId       String? @unique @map("approval_id")

  // Timestamps
  submittedAt DateTime? @map("submitted_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  attachments RequestAttachment[]
  comments    RequestComment[]
  history     RequestHistory[]

  @@index([requesterId])
  @@index([assignedToId])
  @@index([status])
  @@index([type, category])
  @@index([dueDate])
  @@index([createdAt])
  @@map("requests")
}

model RequestAttachment {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  fileName     String   @map("file_name") @db.VarChar(255)
  filePath     String   @map("file_path") @db.VarChar(512)
  fileSize     Int      @map("file_size")
  mimeType     String   @map("mime_type") @db.VarChar(100)
  uploadedById String   @map("uploaded_by_id")
  uploadedBy   User     @relation("UploadedAttachments", fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([requestId])
  @@map("request_attachments")
}

model RequestComment {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  authorId   String    @map("author_id")
  author     User      @relation("RequestComments", fields: [authorId], references: [id])
  content    String    @db.Text
  isInternal Boolean   @default(false) @map("is_internal") // Comentário interno (não visível para solicitante)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  @@index([requestId])
  @@index([authorId])
  @@map("request_comments")
}

model RequestHistory {
  id String @id @default(uuid())

  requestId String  @map("request_id")
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  action        String   @db.VarChar(100) // "created", "assigned", "status_changed", etc
  description   String   @db.Text
  performedById String   @map("performed_by_id")
  performedBy   User     @relation("RequestHistoryActions", fields: [performedById], references: [id])
  oldValue      Json?    @map("old_value")
  newValue      Json?    @map("new_value")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([requestId])
  @@index([createdAt])
  @@map("request_history")
}

// ===============================================
// HUMAN RESOURCES MODULE
// ===============================================

// --- Enums ---

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  VACATION
  SUSPENDED
  TERMINATED
}

enum ContractType {
  CLT
  PJ
  INTERN
  TEMPORARY
  APPRENTICE
}

enum WorkRegime {
  FULL_TIME
  PART_TIME
  HOURLY
  SHIFT
  FLEXIBLE
}

// --- Entidades ---

model Employee {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  // Identificação
  registrationNumber String @map("registration_number") @db.VarChar(32)

  // Vinculação com usuário (opcional)
  userId String? @unique @map("user_id")

  // Dados pessoais
  fullName             String    @db.VarChar(256)
  socialName           String?   @db.VarChar(256)
  birthDate            DateTime? @map("birth_date")
  gender               String?   @db.VarChar(32)
  pcd                  Boolean   @default(false)
  maritalStatus        String?   @db.VarChar(32)
  nationality          String?   @db.VarChar(64)
  birthPlace           String?   @db.VarChar(128)
  emergencyContactInfo Json?     @map("emergency_contact_info")
  healthConditions     Json?     @map("health_conditions")

  // Documentos
  cpf         String    @db.VarChar(14)
  rg          String?   @db.VarChar(20)
  rgIssuer    String?   @map("rg_issuer") @db.VarChar(32)
  rgIssueDate DateTime? @map("rg_issue_date")
  pis         String?   @db.VarChar(14)
  ctpsNumber  String?   @db.VarChar(32)
  ctpsSeries  String?   @db.VarChar(16)
  ctpsState   String?   @db.VarChar(2)
  voterTitle  String?   @db.VarChar(16)
  militaryDoc String?   @db.VarChar(32)

  // Contato
  email            String? @db.VarChar(254)
  personalEmail    String? @map("personal_email") @db.VarChar(254)
  phone            String? @db.VarChar(20)
  mobilePhone      String? @map("mobile_phone") @db.VarChar(20)
  emergencyContact String? @map("emergency_contact") @db.VarChar(128)
  emergencyPhone   String? @map("emergency_phone") @db.VarChar(20)

  // Endereço
  address       String? @db.VarChar(256)
  addressNumber String? @db.VarChar(16)
  complement    String? @db.VarChar(128)
  neighborhood  String? @db.VarChar(128)
  city          String? @db.VarChar(128)
  state         String? @db.VarChar(2)
  zipCode       String? @map("zip_code") @db.VarChar(10)
  country       String  @default("Brasil") @db.VarChar(64)

  // Dados bancários
  bankCode        String? @db.VarChar(8)
  bankName        String? @db.VarChar(128)
  bankAgency      String? @db.VarChar(16)
  bankAccount     String? @db.VarChar(32)
  bankAccountType String? @db.VarChar(32)
  pixKey          String? @db.VarChar(128)

  // Vínculo empregatício
  departmentId    String?        @map("department_id")
  positionId      String?        @map("position_id")
  supervisorId    String?        @map("supervisor_id")
  organizationId  String?        @map("organization_id")
  hireDate        DateTime       @map("hire_date")
  terminationDate DateTime?      @map("termination_date")
  status          EmployeeStatus @default(ACTIVE)
  baseSalary      Decimal        @map("base_salary") @db.Decimal(10, 2)
  contractType    ContractType   @map("contract_type")
  workRegime      WorkRegime     @map("work_regime")
  weeklyHours     Decimal        @map("weekly_hours") @db.Decimal(5, 2) // Horas semanais
  photoUrl        String?        @map("photo_url") @db.VarChar(512)

  // Metadados flexíveis
  metadata      Json @default("{}")
  pendingIssues Json @default("[]") @map("pending_issues")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  department   Department?   @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  position     Position?     @relation(fields: [positionId], references: [id])
  supervisor   Employee?     @relation("EmployeeSupervisor", fields: [supervisorId], references: [id])
  subordinates Employee[]    @relation("EmployeeSupervisor")
  organization Organization? @relation(fields: [organizationId], references: [id])

  // Time Control
  timeEntries TimeEntry[]

  // Absences
  absences Absence[]

  // Payroll
  payrollItems PayrollItem[]

  // Overtime
  overtime Overtime[]

  // Time Bank
  timeBanks TimeBank[]

  // Vacation
  vacationPeriods VacationPeriod[]

  // Bonuses
  bonuses Bonus[]

  // Deductions
  deductions Deduction[]

  // Management
  managedDepartments Department[] @relation("DepartmentManager")
  company            Company?     @relation(fields: [companyId], references: [id])
  companyId          String?

  @@unique([registrationNumber, tenantId, deletedAt], name: "employees_registration_tenant_unique_active")
  @@unique([cpf, tenantId, deletedAt], name: "employees_cpf_tenant_unique_active")
  @@unique([pis, tenantId, deletedAt], name: "employees_pis_tenant_unique_active")
  @@index([tenantId])
  @@index([userId])
  @@index([cpf])
  @@index([registrationNumber])
  @@index([departmentId])
  @@index([positionId])
  @@index([supervisorId])
  @@index([status])
  @@index([hireDate])
  @@index([terminationDate])
  @@index([deletedAt])
  @@index([organizationId])
  @@map("employees")
}

model Department {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  name        String  @db.VarChar(128)
  code        String  @db.VarChar(32)
  description String? @db.Text
  parentId    String? @map("parent_id")
  managerId   String? @map("manager_id")
  companyId   String  @map("company_id")
  isActive    Boolean @default(true) @map("is_active")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant       @relation(fields: [tenantId], references: [id])
  parent    Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DepartmentHierarchy")
  manager   Employee?    @relation("DepartmentManager", fields: [managerId], references: [id])
  company   Company      @relation(fields: [companyId], references: [id])
  positions Position[]
  employees Employee[]   @relation("DepartmentEmployees")

  @@unique([code, companyId, tenantId, deletedAt], name: "departments_code_company_tenant_unique_active")
  @@index([tenantId])
  @@index([code])
  @@index([parentId])
  @@index([managerId])
  @@index([companyId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("departments")
}

model Position {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  name         String   @db.VarChar(128)
  code         String   @db.VarChar(32)
  description  String?  @db.Text
  departmentId String?  @map("department_id")
  level        Int      @default(1)
  minSalary    Decimal? @map("min_salary") @db.Decimal(10, 2)
  maxSalary    Decimal? @map("max_salary") @db.Decimal(10, 2)
  baseSalary   Decimal? @map("base_salary") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])
  employees  Employee[]

  @@unique([code, tenantId], name: "positions_code_tenant_unique")
  @@index([tenantId])
  @@index([code])
  @@index([departmentId])
  @@index([level])
  @@index([isActive])
  @@index([deletedAt])
  @@map("positions")
}

// ===============================================
// TIME CONTROL MODULE
// ===============================================

enum TimeEntryType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
  OVERTIME_START
  OVERTIME_END
}

model TimeEntry {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId String        @map("employee_id")
  entryType  TimeEntryType @map("entry_type")
  timestamp  DateTime
  latitude   Decimal?      @db.Decimal(10, 8)
  longitude  Decimal?      @db.Decimal(11, 8)
  ipAddress  String?       @map("ip_address") @db.VarChar(64)
  notes      String?       @db.Text

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([timestamp])
  @@index([entryType])
  @@index([employeeId, timestamp])
  @@map("time_entries")
}

model WorkSchedule {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  name           String  @db.VarChar(128)
  description    String? @db.Text
  mondayStart    String? @map("monday_start") @db.VarChar(5) // HH:MM format
  mondayEnd      String? @map("monday_end") @db.VarChar(5)
  tuesdayStart   String? @map("tuesday_start") @db.VarChar(5)
  tuesdayEnd     String? @map("tuesday_end") @db.VarChar(5)
  wednesdayStart String? @map("wednesday_start") @db.VarChar(5)
  wednesdayEnd   String? @map("wednesday_end") @db.VarChar(5)
  thursdayStart  String? @map("thursday_start") @db.VarChar(5)
  thursdayEnd    String? @map("thursday_end") @db.VarChar(5)
  fridayStart    String? @map("friday_start") @db.VarChar(5)
  fridayEnd      String? @map("friday_end") @db.VarChar(5)
  saturdayStart  String? @map("saturday_start") @db.VarChar(5)
  saturdayEnd    String? @map("saturday_end") @db.VarChar(5)
  sundayStart    String? @map("sunday_start") @db.VarChar(5)
  sundayEnd      String? @map("sunday_end") @db.VarChar(5)

  breakDuration Int     @default(60) @map("break_duration") // Minutos
  isActive      Boolean @default(true) @map("is_active")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("work_schedules")
}

model Overtime {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId String    @map("employee_id")
  date       DateTime
  hours      Decimal   @db.Decimal(5, 2)
  reason     String    @db.Text
  approved   Boolean   @default(false)
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation(fields: [approvedBy], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([date])
  @@index([approved])
  @@map("overtime")
}

model TimeBank {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId String  @map("employee_id")
  balance    Decimal @db.Decimal(8, 2) // Saldo em horas
  year       Int

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, year])
  @@index([tenantId])
  @@index([employeeId])
  @@map("time_banks")
}

// ===============================================
// ABSENCES MODULE
// ===============================================

enum AbsenceType {
  VACATION
  SICK_LEAVE
  PERSONAL_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
  BEREAVEMENT_LEAVE
  WEDDING_LEAVE
  MEDICAL_APPOINTMENT
  JURY_DUTY
  UNPAID_LEAVE
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  IN_PROGRESS
  COMPLETED
}

model Absence {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId           String        @map("employee_id")
  type                 AbsenceType
  status               AbsenceStatus @default(PENDING)
  userId               String?       @map("user_id")
  startDate            DateTime      @map("start_date")
  endDate              DateTime      @map("end_date")
  totalDays            Int           @map("total_days") // Total days of absence
  reason               String?       @db.Text
  documentUrl          String?       @map("document_url") @db.VarChar(512) // URL do atestado/documento
  cid                  String?       @db.VarChar(10) // Código CID para atestados médicos
  isPaid               Boolean       @default(true) @map("is_paid")
  isInssResponsibility Boolean       @default(false) @map("is_inss_responsibility") // Para afastamentos > 15 dias
  vacationPeriodId     String?       @map("vacation_period_id") // Para férias
  notes                String?       @db.Text

  // Quem solicitou (pode ser diferente do funcionário)
  requestedBy String? @map("requested_by")

  // Aprovação
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation(fields: [approvedBy], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([type])
  @@index([status])
  @@index([startDate, endDate])
  @@index([vacationPeriodId])
  @@index([deletedAt])
  @@map("absences")
}

model VacationPeriod {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId String @map("employee_id")

  // Período Aquisitivo (12 meses de trabalho)
  acquisitionStart DateTime @map("acquisition_start")
  acquisitionEnd   DateTime @map("acquisition_end")

  // Período Concessivo (12 meses para tirar férias)
  concessionStart DateTime @map("concession_start")
  concessionEnd   DateTime @map("concession_end")

  // Dias de direito
  totalDays     Int @default(30) @map("total_days") // Dias totais de direito
  usedDays      Int @default(0) @map("used_days") // Dias já utilizados
  soldDays      Int @default(0) @map("sold_days") // Abono pecuniário (max 10)
  remainingDays Int @default(30) @map("remaining_days") // Saldo disponível

  // Controle de agendamento
  status         String    @default("PENDING") @db.VarChar(32) // PENDING, AVAILABLE, SCHEDULED, IN_PROGRESS, COMPLETED, EXPIRED, SOLD
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")

  notes String? @db.Text

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([acquisitionStart, acquisitionEnd])
  @@index([concessionStart, concessionEnd])
  @@index([deletedAt])
  @@map("vacation_periods")
}

// ===============================================
// PAYROLL MODULE
// ===============================================

enum PayrollStatus {
  DRAFT
  PROCESSING
  CALCULATED
  APPROVED
  PAID
  CANCELLED
}

enum PayrollItemType {
  BASE_SALARY
  BONUS
  COMMISSION
  OVERTIME
  NIGHT_SHIFT
  HAZARD_PAY
  DANGER_PAY
  VACATION_PAY
  THIRTEENTH_SALARY
  HOLIDAY
  INSS
  IRRF
  FGTS
  HEALTH_INSURANCE
  DENTAL_PLAN
  TRANSPORT_VOUCHER
  MEAL_VOUCHER
  OTHER_BENEFIT
  ADVANCE
  LOAN
  OTHER_DEDUCTION
}

model Payroll {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  referenceMonth  Int           @map("reference_month") // 1-12
  referenceYear   Int           @map("reference_year")
  status          PayrollStatus @default(DRAFT)
  totalGross      Decimal       @map("total_gross") @db.Decimal(12, 2)
  totalDeductions Decimal       @map("total_deductions") @db.Decimal(12, 2)
  totalNet        Decimal       @map("total_net") @db.Decimal(12, 2)

  // Processamento
  processedAt DateTime? @map("processed_at")
  processedBy String?   @map("processed_by")

  // Aprovação
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by")

  // Pagamento
  paidAt DateTime? @map("paid_at")
  paidBy String?   @map("paid_by")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant        @relation(fields: [tenantId], references: [id])
  processor User?         @relation("PayrollProcessor", fields: [processedBy], references: [id])
  approver  User?         @relation("PayrollApprover", fields: [approvedBy], references: [id])
  payer     User?         @relation("PayrollPayer", fields: [paidBy], references: [id])
  items     PayrollItem[]

  @@unique([referenceMonth, referenceYear, tenantId], name: "payrolls_month_year_tenant_unique")
  @@index([tenantId])
  @@index([status])
  @@index([referenceYear, referenceMonth])
  @@map("payrolls")
}

model PayrollItem {
  id String @id @default(uuid())

  payrollId   String          @map("payroll_id")
  employeeId  String          @map("employee_id")
  type        PayrollItemType
  description String          @db.VarChar(256)
  amount      Decimal         @db.Decimal(10, 2)
  isDeduction Boolean         @default(false) @map("is_deduction")

  // Referências externas
  referenceId   String? @map("reference_id") // ID de overtime, absence, etc
  referenceType String? @map("reference_type") // "overtime", "absence", etc

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payroll  Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([payrollId])
  @@index([employeeId])
  @@index([type])
  @@map("payroll_items")
}

model Bonus {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId String   @map("employee_id")
  name       String   @db.VarChar(128)
  amount     Decimal  @db.Decimal(10, 2)
  reason     String   @db.Text
  date       DateTime
  isPaid     Boolean  @default(false) @map("is_paid")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([date])
  @@index([isPaid])
  @@map("bonuses")
}

model Deduction {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  employeeId         String    @map("employee_id")
  name               String    @db.VarChar(128)
  amount             Decimal   @db.Decimal(10, 2)
  reason             String    @db.Text
  date               DateTime
  isRecurring        Boolean   @default(false) @map("is_recurring")
  installments       Int?      @map("installments")
  currentInstallment Int       @default(0) @map("current_installment")
  isApplied          Boolean   @default(false) @map("is_applied")
  appliedAt          DateTime? @map("applied_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@index([date])
  @@index([isApplied])
  @@index([isRecurring])
  @@map("deductions")
}

// ===============================================
// COMPANY MODULE
// ===============================================

enum CompanyAddressType {
  FISCAL
  DELIVERY
  BILLING
  OTHER
}

enum CompanyCnaeStatus {
  ACTIVE
  INACTIVE
}

enum NfeEnvironment {
  HOMOLOGATION
  PRODUCTION
}

enum DigitalCertificateType {
  NONE
  A1
  A3
}

enum CompanyStakeholderRole {
  SOCIO
  ADMINISTRADOR
  PROCURADOR
  REPRESENTANTE_LEGAL
  GERENTE
  DIRETOR
  OUTRO
}

enum CompanyStakeholderStatus {
  ACTIVE
  INACTIVE
}

enum CompanyStakeholderSource {
  CNPJ_API
  MANUAL
}

model Company {
  id String @id @default(uuid())

  // Multi-Tenant
  tenantId String @map("tenant_id")

  // Dados obrigatórios
  legalName String @map("legal_name") @db.VarChar(256)
  cnpj      String @db.VarChar(18)

  // Dados opcionais principais
  tradeName             String?           @map("trade_name") @db.VarChar(256)
  stateRegistration     String?           @map("state_registration") @db.VarChar(128)
  municipalRegistration String?           @map("municipal_registration") @db.VarChar(128)
  legalNature           String?           @map("legal_nature") @db.VarChar(256)
  taxRegime             TaxRegimeEnum?    @map("tax_regime")
  taxRegimeDetail       String?           @map("tax_regime_detail") @db.VarChar(256)
  activityStartDate     DateTime?         @map("activity_start_date")
  status                CompanyStatusEnum @default(ACTIVE)
  email                 String?           @db.VarChar(256)
  phoneMain             String?           @map("phone_main") @db.VarChar(20)
  phoneAlt              String?           @map("phone_alt") @db.VarChar(20)
  logoUrl               String?           @map("logo_url") @db.VarChar(512)

  // Metadados e pendências
  metadata      Json     @default("{}")
  pendingIssues String[] @default([])

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant                 @relation(fields: [tenantId], references: [id])
  employees      Employee[]
  departments    Department[]
  addresses      CompanyAddress[]
  cnaes          CompanyCnae[]
  fiscalSettings CompanyFiscalSettings?
  stakeholders   CompanyStakeholder[]
  // Finance domain
  costCenters  CostCenter[]
  bankAccounts BankAccount[]

  @@unique([cnpj, tenantId, deletedAt], name: "companies_cnpj_tenant_unique_active")
  @@index([tenantId])
  @@index([cnpj])
  @@index([legalName])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("companies")
}

model CompanyAddress {
  id String @id @default(uuid())

  companyId    String             @map("company_id")
  type         CompanyAddressType @default(OTHER)
  street       String?            @db.VarChar(256)
  number       String?            @db.VarChar(32)
  complement   String?            @db.VarChar(128)
  district     String?            @db.VarChar(128)
  city         String?            @db.VarChar(128)
  state        String?            @db.VarChar(2)
  zip          String             @db.VarChar(10)
  ibgeCityCode String?            @map("ibge_city_code") @db.VarChar(16)
  countryCode  String?            @default("BR") @map("country_code") @db.VarChar(4)
  isPrimary    Boolean            @default(false) @map("is_primary")

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, type, deletedAt], name: "company_addresses_company_type_unique_active")
  @@index([companyId])
  @@index([type])
  @@index([zip])
  @@index([isPrimary])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("company_addresses")
}

model CompanyCnae {
  id String @id @default(uuid())

  companyId   String            @map("company_id")
  code        String            @db.VarChar(16)
  description String?           @db.VarChar(256)
  isPrimary   Boolean           @default(false) @map("is_primary")
  status      CompanyCnaeStatus @default(ACTIVE)

  metadata      Json      @default("{}")
  pendingIssues Json      @default("[]") @map("pending_issues")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, code, deletedAt], name: "company_cnaes_company_code_unique_active")
  @@index([companyId])
  @@index([code])
  @@index([isPrimary])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("company_cnaes")
}

model CompanyFiscalSettings {
  id String @id @default(uuid())

  companyId String @unique @map("company_id")

  // NF-e Configuration
  nfeEnvironment            NfeEnvironment? @map("nfe_environment")
  nfeSeries                 String?         @map("nfe_series") @db.VarChar(16)
  nfeLastNumber             Int?            @map("nfe_last_number")
  nfeDefaultOperationNature String?         @map("nfe_default_operation_nature") @db.VarChar(256)
  nfeDefaultCfop            String?         @map("nfe_default_cfop") @db.VarChar(8)

  // Digital Certificate Configuration
  digitalCertificateType DigitalCertificateType @default(NONE) @map("digital_certificate_type")
  certificateA1PfxBlob   Bytes?                 @map("certificate_a1_pfx_blob")
  certificateA1Password  String?                @map("certificate_a1_password")
  certificateA1ExpiresAt DateTime?              @map("certificate_a1_expires_at")

  // NFC-e Configuration
  nfceEnabled  Boolean @default(false) @map("nfce_enabled")
  nfceCscId    String? @map("nfce_csc_id") @db.VarChar(64)
  nfceCscToken String? @map("nfce_csc_token") @db.VarChar(256)

  // Optional Tax Profile reference
  defaultTaxProfileId String? @map("default_tax_profile_id")

  // Metadata
  metadata      Json @default("{}")
  pendingIssues Json @default("[]") @map("pending_issues")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([digitalCertificateType])
  @@index([nfeEnvironment])
  @@index([nfceEnabled])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("company_fiscal_settings")
}

model CompanyStakeholder {
  id String @id @default(uuid())

  companyId String @map("company_id")

  // Personal Information
  name                 String                  @db.VarChar(256)
  role                 CompanyStakeholderRole? @map("role")
  entryDate            DateTime?               @map("entry_date") @db.Date
  exitDate             DateTime?               @map("exit_date") @db.Date
  personDocumentMasked String?                 @map("person_document_masked") @db.VarChar(32)

  // Legal Information
  isLegalRepresentative Boolean                  @default(false) @map("is_legal_representative")
  status                CompanyStakeholderStatus @default(ACTIVE)

  // Data Source
  source        CompanyStakeholderSource @default(MANUAL)
  rawPayloadRef String?                  @map("raw_payload_ref") @db.VarChar(512)

  // Metadata and Pending Issues
  metadata      Json @default("{}")
  pendingIssues Json @default("[]") @map("pending_issues")

  // Soft Delete with Anonimization
  anonimizedAt DateTime? @map("anonimized_at")
  deletedAt    DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name, role, deletedAt], name: "company_stakeholders_company_name_role_unique_active")
  @@index([companyId])
  @@index([role])
  @@index([status])
  @@index([isLegalRepresentative])
  @@index([source])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("company_stakeholders")
}

// ===============================================
// LABEL TEMPLATES MODULE (Core)
// ===============================================

model LabelTemplate {
  id String @id @default(uuid())

  // Identificação
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Sistema (templates pré-definidos que não podem ser editados/deletados)
  isSystem Boolean @default(false) @map("is_system")

  // Dimensões em milímetros
  width  Int // 10-300mm
  height Int // 10-300mm

  // Dados do GrapesJS (editor de templates)
  grapesJsData String @map("grapes_js_data") @db.Text // JSON do projeto GrapesJS

  // HTML/CSS compilados para impressão
  compiledHtml String? @map("compiled_html") @db.Text
  compiledCss  String? @map("compiled_css") @db.Text

  // Thumbnail gerada
  thumbnailUrl String? @map("thumbnail_url") @db.VarChar(500)

  // Tenant (multi-tenant)
  tenantId String @map("tenant_id")

  // Criado por
  createdById String @map("created_by_id")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdBy User   @relation(fields: [createdById], references: [id])

  @@unique([tenantId, name, deletedAt], name: "label_templates_name_tenant_unique_active")
  @@index([tenantId])
  @@index([isSystem])
  @@index([createdById])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("label_templates")
}

// ===============================================
// MULTI-TENANT MODULE
// ===============================================

// --- Enums ---

enum TenantStatusEnum {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PlanTierEnum {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SystemModuleEnum {
  CORE
  STOCK
  SALES
  HR
  PAYROLL
  REPORTS
  AUDIT
  REQUESTS
  NOTIFICATIONS
  FINANCE
}

// --- Entidades ---

model Tenant {
  id String @id @default(uuid())

  name    String           @db.VarChar(128)
  slug    String           @unique @db.VarChar(128)
  logoUrl String?          @map("logo_url") @db.VarChar(500)
  status  TenantStatusEnum @default(ACTIVE)

  // JSON fields
  settings Json @default("{}")
  metadata Json @default("{}")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenantUsers        TenantUser[]
  tenantPlans        TenantPlan[]
  tenantFeatureFlags TenantFeatureFlag[]
  permissionGroups   PermissionGroup[]
  sessions           Session[]
  refreshTokens      RefreshToken[]

  // Stock domain
  warehouses      Warehouse[]
  zones           Zone[]
  bins            Bin[]
  templates       Template[]
  products        Product[]
  variants        Variant[]
  items           Item[]
  itemMovements   ItemMovement[]
  categories      Category[]
  tags            Tag[]
  suppliers       Supplier[]
  manufacturers   Manufacturer[]
  volumes         Volume[]
  purchaseOrders  PurchaseOrder[]
  // Sales domain
  customers       Customer[]
  salesOrders     SalesOrder[]
  // HR domain
  companies       Company[]
  departments     Department[]
  positions       Position[]
  employees       Employee[]
  timeEntries     TimeEntry[]
  workSchedules   WorkSchedule[]
  overtime        Overtime[]
  timeBanks       TimeBank[]
  absences        Absence[]
  vacationPeriods VacationPeriod[]
  payrolls        Payroll[]
  bonuses         Bonus[]
  deductions      Deduction[]
  // Audit domain
  auditLogs       AuditLog[]
  // Core domain
  labelTemplates  LabelTemplate[]
  // Finance domain
  costCenters       CostCenter[]
  bankAccounts      BankAccount[]
  financeCategories FinanceCategory[]
  financeEntries    FinanceEntry[]

  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("tenants")
}

model Plan {
  id String @id @default(uuid())

  name        String       @unique @db.VarChar(64)
  tier        PlanTierEnum @default(FREE)
  description String?      @db.VarChar(500)
  price       Float        @default(0)
  isActive    Boolean      @default(true) @map("is_active")

  // Limits
  maxUsers      Int @default(5) @map("max_users")
  maxWarehouses Int @default(1) @map("max_warehouses")
  maxProducts   Int @default(100) @map("max_products")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenantPlans TenantPlan[]
  planModules PlanModule[]

  @@index([tier])
  @@index([isActive])
  @@map("plans")
}

model PlanModule {
  id String @id @default(uuid())

  planId String           @map("plan_id")
  module SystemModuleEnum

  // Relations
  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, module])
  @@index([planId])
  @@map("plan_modules")
}

model TenantPlan {
  id String @id @default(uuid())

  tenantId  String    @map("tenant_id")
  planId    String    @map("plan_id")
  startsAt  DateTime  @default(now()) @map("starts_at")
  expiresAt DateTime? @map("expires_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([planId])
  @@map("tenant_plans")
}

model TenantUser {
  id String @id @default(uuid())

  tenantId String @map("tenant_id")
  userId   String @map("user_id")
  role     String @default("member") @db.VarChar(32)

  // Dates
  joinedAt  DateTime  @default(now()) @map("joined_at")
  deletedAt DateTime? @map("deleted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, deletedAt], name: "tenant_users_unique_active")
  @@index([tenantId])
  @@index([userId])
  @@index([deletedAt])
  @@map("tenant_users")
}

model TenantFeatureFlag {
  id String @id @default(uuid())

  tenantId String  @map("tenant_id")
  flag     String  @db.VarChar(64)
  enabled  Boolean @default(false)

  // JSON metadata
  metadata Json @default("{}")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, flag])
  @@index([tenantId])
  @@map("tenant_feature_flags")
}

// ===============================================
// FINANCE MODULE
// ===============================================

model CostCenter {
  id String @id @default(uuid())

  tenantId    String  @map("tenant_id")
  companyId   String? @map("company_id")
  code        String  @db.VarChar(32)
  name        String  @db.VarChar(128)
  description String? @db.VarChar(500)
  isActive    Boolean @default(true) @map("is_active")

  monthlyBudget Decimal? @map("monthly_budget") @db.Decimal(15, 2)
  annualBudget  Decimal? @map("annual_budget") @db.Decimal(15, 2)

  parentId String? @map("parent_id")

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant   Tenant      @relation(fields: [tenantId], references: [id])
  company  Company?    @relation(fields: [companyId], references: [id])
  parent   CostCenter? @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children CostCenter[] @relation("CostCenterHierarchy")

  financeEntries FinanceEntry[]

  @@unique([code, tenantId, deletedAt], name: "cost_centers_code_tenant_unique_active")
  @@index([tenantId])
  @@index([companyId])
  @@index([parentId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("cost_centers")
}

model BankAccount {
  id String @id @default(uuid())

  tenantId       String            @map("tenant_id")
  companyId      String            @map("company_id")
  name           String            @db.VarChar(128)
  bankCode       String            @map("bank_code") @db.VarChar(5)
  bankName       String?           @map("bank_name") @db.VarChar(128)
  agency         String            @db.VarChar(10)
  agencyDigit    String?           @map("agency_digit") @db.VarChar(2)
  accountNumber  String            @map("account_number") @db.VarChar(20)
  accountDigit   String?           @map("account_digit") @db.VarChar(2)
  accountType    BankAccountType   @map("account_type")
  status         BankAccountStatus @default(ACTIVE)

  pixKeyType     String? @map("pix_key_type") @db.VarChar(16)
  pixKey         String? @map("pix_key") @db.VarChar(128)

  currentBalance   Decimal   @default(0) @map("current_balance") @db.Decimal(15, 2)
  balanceUpdatedAt DateTime? @map("balance_updated_at")

  color     String?  @db.VarChar(7)
  isDefault Boolean  @default(false) @map("is_default")

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  financeEntries  FinanceEntry[]
  financePayments FinanceEntryPayment[]

  @@unique([tenantId, bankCode, agency, accountNumber, deletedAt], name: "bank_accounts_unique_active")
  @@index([tenantId])
  @@index([companyId])
  @@index([bankCode])
  @@index([accountType])
  @@index([status])
  @@index([deletedAt])
  @@map("bank_accounts")
}

model FinanceCategory {
  id String @id @default(uuid())

  tenantId     String               @map("tenant_id")
  name         String               @db.VarChar(128)
  slug         String               @db.VarChar(128)
  description  String?              @db.VarChar(500)
  iconUrl      String?              @map("icon_url") @db.VarChar(512)
  color        String?              @db.VarChar(7)
  type         FinanceCategoryType
  parentId     String?              @map("parent_id")
  displayOrder Int                  @default(0) @map("display_order")
  isActive     Boolean              @default(true) @map("is_active")
  isSystem     Boolean              @default(false) @map("is_system")

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  parent         FinanceCategory?  @relation("FinanceCategoryHierarchy", fields: [parentId], references: [id])
  children       FinanceCategory[] @relation("FinanceCategoryHierarchy")

  financeEntries FinanceEntry[]

  @@unique([slug, tenantId, deletedAt], name: "finance_categories_slug_tenant_unique_active")
  @@index([tenantId])
  @@index([type])
  @@index([parentId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("finance_categories")
}

model FinanceEntry {
  id String @id @default(uuid())

  tenantId String           @map("tenant_id")
  type     FinanceEntryType

  code        String  @db.VarChar(32)
  description String  @db.VarChar(500)
  notes       String? @db.Text

  categoryId    String  @map("category_id")
  costCenterId  String  @map("cost_center_id")
  bankAccountId String? @map("bank_account_id")

  supplierName String? @map("supplier_name") @db.VarChar(256)
  customerName String? @map("customer_name") @db.VarChar(256)
  supplierId   String? @map("supplier_id")
  customerId   String? @map("customer_id")
  salesOrderId String? @map("sales_order_id")

  expectedAmount Decimal  @map("expected_amount") @db.Decimal(15, 2)
  actualAmount   Decimal? @map("actual_amount") @db.Decimal(15, 2)
  discount       Decimal  @default(0) @db.Decimal(15, 2)
  interest       Decimal  @default(0) @db.Decimal(15, 2)
  penalty        Decimal  @default(0) @db.Decimal(15, 2)

  issueDate      DateTime  @map("issue_date")
  dueDate        DateTime  @map("due_date")
  competenceDate DateTime? @map("competence_date")
  paymentDate    DateTime? @map("payment_date")

  status FinanceEntryStatus @default(PENDING)

  recurrenceType     FinanceEntryRecurrence @default(SINGLE) @map("recurrence_type")
  recurrenceInterval Int?                   @map("recurrence_interval")
  recurrenceUnit     RecurrenceUnit?        @map("recurrence_unit")
  totalInstallments  Int?                   @map("total_installments")
  currentInstallment Int?                   @map("current_installment")
  parentEntryId      String?                @map("parent_entry_id")

  boletoBarcode   String? @map("boleto_barcode") @db.VarChar(64)
  boletoDigitLine String? @map("boleto_digit_line") @db.VarChar(64)

  metadata Json     @default("{}")
  tags     String[] @default([])

  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  category    FinanceCategory @relation(fields: [categoryId], references: [id])
  costCenter  CostCenter      @relation(fields: [costCenterId], references: [id])
  bankAccount BankAccount?    @relation(fields: [bankAccountId], references: [id])
  parentEntry FinanceEntry?   @relation("EntryRecurrence", fields: [parentEntryId], references: [id])
  childEntries FinanceEntry[] @relation("EntryRecurrence")

  payments FinanceEntryPayment[]

  @@unique([code, tenantId, deletedAt], name: "finance_entries_code_tenant_unique_active")
  @@index([tenantId])
  @@index([type])
  @@index([categoryId])
  @@index([costCenterId])
  @@index([bankAccountId])
  @@index([status])
  @@index([dueDate])
  @@index([paymentDate])
  @@index([recurrenceType])
  @@index([parentEntryId])
  @@index([createdBy])
  @@index([deletedAt])
  @@index([tenantId, type, status])
  @@index([tenantId, dueDate, status])
  @@map("finance_entries")
}

model FinanceEntryPayment {
  id String @id @default(uuid())

  entryId       String  @map("entry_id")
  bankAccountId String? @map("bank_account_id")

  amount    Decimal  @db.Decimal(15, 2)
  paidAt    DateTime @map("paid_at")
  method    String?  @db.VarChar(32)
  reference String?  @db.VarChar(128)
  notes     String?  @db.Text

  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  entry       FinanceEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])

  @@index([entryId])
  @@index([bankAccountId])
  @@index([paidAt])
  @@map("finance_entry_payments")
}
